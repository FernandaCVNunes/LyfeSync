{# autocuidado/gratidao.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}Minhas Gratidões{% endblock %}

{% block extra_css %}
    {# Inclui o CSS específico do módulo Autocuidado #}
    <link rel="stylesheet" href="{% static 'css/autocuidado.css' %}">
{% endblock %}

{# -------------------------------------------------------------------------------- #}
{# BLOCO: FUNÇÕES GLOBAIS E URLs para uso em JavaScript #}
{# -------------------------------------------------------------------------------- #}
{% block extra_scripts %}
<script>
    // As URLs BASE são usadas pelo JS para construir a URL final com o ID.
    const URL_GRATIDAO = "{% url 'gratidao' %}"; 
    const URL_ALTERACAO_BASE_GRATIDAO = "{% url 'alterar_gratidao' gratidao_id=0 %}"; 
    const URL_DELETE_TEMPLATE_GRATIDAO = "{% url 'delete_gratidao' gratidao_id=0 %}"; 
</script>
{% endblock extra_scripts %}

{% block content_logado %}
    <div class="container py-4">
        
        {# Bloco de Mensagens do Django (Messages Framework) #}
        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags|default_if_none:'info' }} alert-dismissible fade show rounded-3 shadow" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="row g-4 justify-content-center">
            
            {# Coluna Principal #}
            <div class="col-lg-10">
                <div class="container mx-auto p-4 max-w-4xl">

                    {# NOVO CARD UNIFICADO: Título, Botão de Inclusão e Gratidões HOJE #}
                    <div class="card p-4 rounded-4 shadow-lg mb-4">
                        
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="h3 fw-extrabold gratidao-title m-0">Minhas Gratidões</h1> 
                            
                            {# BOTÃO MENOR E NO TOPO #}
                            <button type="button" 
                                        class="btn btn-primary fw-bold shadow-sm rounded-pill px-4 py-2"
                                        data-bs-toggle="modal"
                                        data-bs-target="#inclusaoGratidaoModal">
                                <i class="bi bi-plus-circle me-2"></i> Incluir Nova Gratidão
                            </button>
                        </div>
                        
                        <hr class="mb-4">

                        {# NOVO BLOCO: Gratidões HOJE (AGORA DENTRO DO MESMO CARD) #}
                        <h2 class="h5 fw-bold mb-3 gratidao-title"><i class="bi bi-star-fill me-2"></i> Gratidões Registradas HOJE</h2>
                        
                        {% if gratidao_do_dia %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover rounded-3 overflow-hidden shadow-sm align-middle">
                                    <thead class="bg-success">
                                        <tr>
                                            <th scope="col" class="py-3">Data</th>
                                            <th scope="col">Frase</th>
                                            <th scope="col" class="text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-ligh ">
                                        {% for gratidao in gratidao_do_dia %}
                                        <tr class="gratidao-tabela-row">
                                            
                                            <td class="fw-medium ">{{ gratidao.data|date:"d/m/Y" }}</td>
                                            <td class="fw-bold fw-medium fs-5 fst-italic">"{{ gratidao.descricaogratidao|default:"Nenhuma descrição." }}"</td>
                                            <td class="text-center ">
                                                {# Botão Alterar #}
                                                <a href="#" 
                                                    class="btn btn-sm btn-outline-primary rounded-pill" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#alteracaoGratidaoUnicaModal"
                                                    data-gratidao-id="{{ gratidao.idgratidao }}"
                                                    data-gratidao-data="{{ gratidao.data|date:'Y-m-d' }}" 
                                                    data-gratidao-conteudo="{{ gratidao.descricaogratidao|urlencode }}" 
                                                    >
                                                    Alterar
                                                </a>
                                                
                                                {# Botão Excluir #}
                                                <button type="button" 
                                                            class="btn btn-sm btn-outline-danger rounded-pill" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#excluirGratidaoModal"
                                                            data-gratidao-id="{{ gratidao.idgratidao }}"
                                                            data-gratidao-data="{{ gratidao.data|date:'d/m/Y' }}">
                                                    Excluir
                                                </button>
                                            </td>
                                            {# FIM da <td> de Ações #}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="bg-light p-3 rounded-3 shadow-sm">
                                <p class="text-secondary fst-italic text-center mb-0">
                                    Você ainda não registrou nenhuma gratidão hoje. Clique em **Incluir Nova Gratidão** acima para começar!
                                </p>
                            </div>
                        {% endif %}
                    </div>
                    {# ======================================================= #}
                    {# HISTÓRICO DE GRATIDÃO  #}
                    {# ======================================================= #}
                    <h2 class="h4 fw-bold mt-5 mb-3 text-secondary border-bottom pb-2">Histórico Completo de Gratidão (Últimas {{ gratidoes_paginadas.paginator.per_page }})</h2>

                    {% if gratidoes_paginadas %}
                        <div class="d-grid gap-3">
                            {% for gratidao in gratidoes_paginadas %}
                            {# O histórico agora deve excluir os itens de hoje para evitar duplicidade #}
                            {# **ATENÇÃO:** A lógica de exclusão de duplicidade deve vir da VIEW! #}
                            <div class="card p-3 rounded-3 shadow-sm border border-light-subtle transition-hover">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <p class="small fw-semibold text-uppercase gratidao-title mb-1">
                                            {{ gratidao.data|date:"d/m/Y (l)" }} 
                                        </p>
                                        {# Exibir a descrição completa #}
                                        <p class="text-dark mt-1">
                                            {{ gratidao.descricaogratidao|default:"[Sem descrição]..." }}
                                        </p>
                                    </div>
                                    
                                    <div class="d-flex gap-2 ms-4 flex-shrink-0">
                                        {# Botão Alterar Histórico para abrir Modal #}
                                        <a href="#" 
                                            class="btn btn-sm btn-outline-primary rounded-pill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#alteracaoGratidaoUnicaModal"
                                            data-gratidao-id="{{ gratidao.idgratidao }}"
                                            data-gratidao-data="{{ gratidao.data|date:'Y-m-d' }}" 
                                            data-gratidao-conteudo="{{ gratidao.descricaogratidao|urlencode }}" 
                                            >
                                            Alterar
                                        </a>
                                        
                                        {# Botão Excluir Histórico para abrir Modal de Confirmação #}
                                        <button type="button" 
                                                    class="btn btn-sm btn-outline-danger rounded-pill" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#excluirGratidaoModal"
                                                    data-gratidao-id="{{ gratidao.idgratidao }}"
                                                    data-gratidao-data="{{ gratidao.data|date:'d/m/Y' }}"
                                                    >
                                                    Excluir
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {# Paginação #}
                        <div class="d-flex justify-content-center mt-4"> 
                            <nav aria-label="Paginação">
                                <ul class="pagination shadow-sm rounded-3">
                                    
                                    {% if gratidoes_paginadas.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link rounded-start-3" href="?page={{ gratidoes_paginadas.previous_page_number }}" aria-label="Previous">
                                                &lsaquo; Anterior
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link rounded-start-3" aria-label="Previous">
                                                &lsaquo; Anterior
                                            </span>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link bg-primary border-primary text-white">
                                            Página {{ gratidoes_paginadas.number }} de {{ gratidoes_paginadas.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if gratidoes_paginadas.has_next %}
                                        <li class="page-item">
                                            <a class="page-link rounded-end-3" href="?page={{ gratidoes_paginadas.next_page_number }}" aria-label="Next">
                                                Próxima &rsaquo;
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link rounded-end-3" aria-label="Next">
                                                Próxima &rsaquo;
                                            </span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    {% else %}
                        <p class="text-secondary fst-italic mt-4 p-3 bg-white rounded-3 shadow-sm">Nenhum registro de gratidão encontrado no histórico.</p>
                    {% endif %}

                </div>
            
                {# Frase Motivacional #}
                <div class="row mt-4">
                    <div class="col-12">
                        <p class="text-center gratidao-title fst-italic fw-bold">“O reconhecimento da gratidão é a chave para abrir a porta da abundância.”</p>
                    </div>
                </div>

            </div>
        </div>

    {# ======================================================================= #}
    {# MODAL: INCLUSÃO DE GRATIDÃO (Com data selecionável) #}
    {# ======================================================================= #}
    <div class="modal fade" id="inclusaoGratidaoModal" tabindex="-1" aria-labelledby="inclusaoGratidaoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                
                <form method="POST" action="{% url 'registrar_gratidao' %}" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="modal-header bg-primary text-white border-0">
                        <h5 class="modal-title" id="inclusaoGratidaoModalLabel">Registrar Gratidão</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="modal-body p-4">
                        {{ formset.management_form }}
                        
                        <p class="text-secondary mb-3">Você pode registrar até **3 gratidões** por vez para a data selecionada.</p>
                        
                        <div class="row g-3">
                            {% for form in formset %}
                                {% if forloop.first %}
                                    {# Apenas o primeiro form renderiza o campo de data principal #}
                                    <div class="col-12 mb-3">
                                        <label for="{{ form.data.id_for_label }}" class="form-label h5 fw-semibold text-secondary mb-2">Data da Gratidão:</label>
                                        {# O valor 'initial' (data de hoje) virá do forms.py #}
                                        {% render_field form.data class="form-control form-control-lg bg-light" max=hoje_iso %}
                                        <div class="form-text">
                                            Você pode mudar a data se for um registro retroativo.
                                        </div>
                                    </div>
                                {% endif %}

                                <div class="col-12">
                                    <div class="p-3 border rounded-3 bg-light">
                                        {{ form.descricaogratidao.errors }}
                                        <label for="{{ form.descricaogratidao.id_for_label }}" class="form-label small fw-medium text-secondary">Gratidão #{{ forloop.counter }}:</label>
                                        {% render_field form.descricaogratidao class="form-control rounded-3" placeholder="Pelo que você é grato hoje?" %}

                                        {% if not forloop.first %}
                                            <div class="d-none">
                                                {{ form.data }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="modal-footer border-top-0">
                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary fw-bold rounded-pill">SALVAR GRATIDÃO(ÕES)</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {# FIM DO MODAL DE INCLUSÃO #}


    {# MODAL ÚNICO DE ALTERAÇÃO (Agora com campo de data editável) #}
    <div class="modal fade" id="alteracaoGratidaoUnicaModal" tabindex="-1" aria-labelledby="alteracaoGratidaoUnicaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                
                <form method="POST" id="form-alteracao-historico-gratidao">
                    {% csrf_token %}
                    <div class="modal-header bg-warning text-dark border-0" id="modal-header-alteracao-historico">
                        <h5 class="modal-title" id="alteracaoGratidaoUnicaModalLabel">Alterar Registro de Gratidão</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    
                    <div class="modal-body p-4">
                        {# Campo de Data: AGORA É EDITÁVEL! #}
                        <div class="mb-4">
                            <label for="id_data_historico_modal" class="form-label h5 fw-semibold text-secondary mb-2">Data:</label>
                            <input type="date" 
                                   id="id_data_historico_modal" 
                                   name="data" 
                                   class="form-control form-control-lg bg-white" 
                                   required 
                                   max="{{ hoje_iso }}" 
                                   />
                            <div class="form-text">
                                Você pode mudar a data desta gratidão.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="id_conteudo_historico_modal"
                                class="form-label h5 fw-semibold text-secondary mb-2">Gratidão:</label>
                            <textarea id="id_conteudo_historico_modal" name="descricaogratidao" rows="5"
                                class="form-control rounded-3" required></textarea>
                        </div>
                    </div>
                    
                    <div class="modal-footer border-top-0">
                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btn-modal-salvar-alteracao" class="btn btn-warning fw-bold rounded-pill">ATUALIZAR</button>
                    </div>
                </form>
                <p id="alteracao-gratidao-id" class="d-none"></p>
            </div>
        </div>
    </div>
    {# FIM DO MODAL DE ALTERAÇÃO ÚNICA #}

    {# MODAL DE CONFIRMAÇÃO PARA EXCLUSÃO (Mantido) #}
    <div class="modal fade" id="excluirGratidaoModal" tabindex="-1" aria-labelledby="excluirGratidaoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title" id="excluirGratidaoModalLabel">Confirmar Exclusão de Gratidão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" id="form-excluir-gratidao">
                    {% csrf_token %}
                    <div class="modal-body p-4">
                        <p class="mb-3">Tem certeza de que deseja **excluir** o registro de gratidão da data:</p>
                        <p class="fw-bold text-danger text-center h5 p-2 bg-light border rounded" id="gratidao-data-confirmacao"></p>
                        <p class="mt-3 text-muted small">Esta ação não pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer border-top-0">
                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger fw-bold rounded-pill">Sim, Excluir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {# FIM DO MODAL DE EXCLUSÃO #}


    <div class="d-flex justify-content-between mt-5">
        <button onclick="window.history.back()" class="btn btn-outline-secondary btn-lg shadow-sm rounded-pill">
            <i class="bi bi-arrow-left me-2"></i> Voltar à Página Anterior
        </button>
    </div>

{% endblock content_logado %}

{# -------------------------------------------------------------------------------- #}
{# BLOCO DE SCRIPTS (Mantido e garantido que funciona com os Modals) #}
{# -------------------------------------------------------------------------------- #}
{% block scripts %}
<script>
    // =======================================================================
    // DOM CONTENT LOADED (Listeners e Inicialização)
    // =======================================================================
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- Referências de Elementos do Modal de Alteração Única ---
        const alteracaoUnicaModalElement = document.getElementById('alteracaoGratidaoUnicaModal');
        const alteracaoForm = document.getElementById('form-alteracao-historico-gratidao');
        const dataHistoricoInput = document.getElementById('id_data_historico_modal');
        const conteudoHistoricoInput = document.getElementById('id_conteudo_historico_modal'); 
        const modalAlteracaoTitle = document.getElementById('alteracaoGratidaoUnicaModalLabel');
        
        // --- LÓGICA DE ALTERAÇÃO ÚNICA (show.bs.modal) - Para o Histórico/Destaque ---
        if (alteracaoUnicaModalElement) {
            alteracaoUnicaModalElement.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; 
                
                // Extrai dados dos atributos data-* do botão/link que acionou o modal
                const gratidaoId = button.getAttribute('data-gratidao-id');
                const dataStr = button.getAttribute('data-gratidao-data'); // Formato YYYY-MM-DD
                
                // Decodifica a URL antes de preencher o campo para garantir caracteres especiais
                const conteudo = decodeURIComponent(button.getAttribute('data-gratidao-conteudo') || ''); 
                
                // Preenche os campos do modal
                // Data agora é editável!
                if (dataHistoricoInput) dataHistoricoInput.value = dataStr;
                if (conteudoHistoricoInput) conteudoHistoricoInput.value = conteudo;
                
                // Define a action do formulário para a alteração (CRÍTICO)
                if (alteracaoForm && gratidaoId) {
                    // Substitui '0' na URL base pelo ID da gratidão
                    const finalAlteracaoUrl = URL_ALTERACAO_BASE_GRATIDAO.replace('0', gratidaoId);
                    alteracaoForm.action = finalAlteracaoUrl;
                }

                // Atualiza Título do Modal
                if (modalAlteracaoTitle && dataStr) {
                    // Converte YYYY-MM-DD para DD/MM/YYYY para exibição no título
                    const dataFormatada = dataStr.split('-').reverse().join('/'); 
                    modalAlteracaoTitle.textContent = `Alterar Registro de Gratidão (${dataFormatada})`;
                }
                
            });
        }

        
        // --- Referências de Elementos do Modal de Exclusão de Gratidão ---
        const excluirModalElement = document.getElementById('excluirGratidaoModal');
        const excluirForm = document.getElementById('form-excluir-gratidao');
        const gratidaoDataConfirmacao = document.getElementById('gratidao-data-confirmacao');

        // --- LÓGICA DE EXCLUSÃO (show.bs.modal) ---
        if (excluirModalElement) {
            excluirModalElement.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                // Extrai dados dos atributos data-* do botão que acionou o modal
                const gratidaoId = button.getAttribute('data-gratidao-id');
                const gratidaoData = button.getAttribute('data-gratidao-data'); // Ex: '23/11/2025'
                
                // 1. Preenche a data para confirmação
                if (gratidaoDataConfirmacao) {
                    gratidaoDataConfirmacao.textContent = gratidaoData;
                }
                
                // 2. Define a action do formulário para exclusão (CRÍTICO)
                if (excluirForm && gratidaoId) {
                    // Substitui '0' na URL base pelo ID da gratidão
                    const finalDeleteUrl = URL_DELETE_TEMPLATE_GRATIDAO.replace('0', gratidaoId);
                    excluirForm.action = finalDeleteUrl;
                }
            });
        }

        const dataInclusaoPrincipal = document.querySelector('#inclusaoGratidaoModal input[name="form-0-data"]');
        const dataInclusaoOutros = document.querySelectorAll('#inclusaoGratidaoModal input[name^="form-"][name$="-data"]:not([name="form-0-data"])');

        if (dataInclusaoPrincipal && dataInclusaoOutros.length > 0) {
            dataInclusaoPrincipal.addEventListener('change', function() {
                const selectedDate = this.value;
                dataInclusaoOutros.forEach(input => {
                    input.value = selectedDate;
                });
            });
        }
    }); 
</script>
{% endblock scripts %}