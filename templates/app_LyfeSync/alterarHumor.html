{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
  Alterar Humor
{% endblock %}

{% block content_logado %}
  <style>
    /* Estilos Customizados Adicionais (Baseado em registrarHumor.html) */
    .humor-image {
      width: 30px;
      height: 30px;
      transition: transform 0.1s;
    }
    
    /* Estilo para o container de humor selecionado */
    .selected-humor {
      background-color: #ecfdf5; /* Tailwind: bg-green-50, um verde claro */
      border: 2px solid #34d399; /* Tailwind: border-green-400 */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: scale(1.05);
    }
    
    /* Estilo para a textarea, baseado na sua imagem de referﾃｪncia */
    .custom-textarea {
      background-color: #e6f7ff; /* Cor azul claro */
      border-radius: 20px;
      border-color: #b3e0ff;
    }
    
    /* Estilo do botﾃ｣o SALVAR (Cor Laranja/Vermelho da imagem de anexo) */
    .btn-salvar-humor {
      background-color: #f44336;
    }
    
    .btn-salvar-humor:hover {
      background-color: #d32f2f;
    }
    
    /* Ajuste de layout */
    .humor-option-item {
      padding: 8px;
      border-radius: 12px;
      border: 2px solid transparent;
      transition: all 0.15s ease-in-out;
    }
  </style>

  {# Se este arquivo CSS nﾃ｣o existir em static/css/ o botﾃ｣o continuarﾃ｡ branco. #}
  <link rel="stylesheet" href="{% static 'css/homeLifesync.css' %}" />

  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="flex flex-wrap gap-4">
      <div class="w-full bg-white p-6 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-lyfesync-green mb-6">Alterar Humor Registrado</h1>

        <form id="form-alteracao-humor" method="POST" action="{% url 'alterarHumor' humor_id=humor_id|default:0 %}">
          {% csrf_token %}

          {# Mensagens de feedback (sucesso/erro) #}
          <div id="feedback-message" class="mb-4 hidden"></div>

          {# 1. SELEﾃﾃグ DE DATA #}
          <div class="mb-6">
            <label for="id_data" class="block text-xl font-semibold text-gray-700 mb-2">Selecione a Data para Ediﾃｧﾃ｣o:</label>
            <input type="date" id="id_data" name="data" class="w-full sm:w-1/2 p-3 border-2 border-green-200 rounded-lg focus:border-lyfesync-green focus:ring focus:ring-green-100 transition duration-150" value="{{ form.data.value|default_if_none:'' }}" required onchange="loadHumorData(this.value)" />
            <input type="hidden" name="humor_id" id="humor_id" value="{{ humor_id|default_if_none:'' }}" />
          </div>

          {# 2. SELEﾃﾃグ DE HUMOR (RENDERIZADO PELO DJANGO) #}
          <div id="humor-selection-container" class="mb-8" style="display: none;">
            <label class="block text-xl font-semibold text-gray-700 mb-4">Novo Humor:</label>

            <div class="flex flex-wrap gap-3">
              {# Renderizaﾃｧﾃ｣o direta dos ﾃｭcones #}
              {% for value, label in form.estado.field.choices %}
                {% with image_path=humor_icon_class_map|get_item:value|default:'img/icon/adchumor.png' %}
                  <div class="humor-option-item cursor-pointer hover:shadow-md transition duration-150 flex flex-col items-center justify-center text-center" data-humor-container data-humor-value="{{ value }}" onclick="selectHumor('{{ value }}', this)">
                    {% if value %}
                      <img src="{% static image_path %}" alt="{{ label }}" class="humor-image" />
                    {% else %}
                      <img src="{% static 'img/icon/adchumor.png' %}" alt="{{ label }}" class="humor-image" />
                    {% endif %}
                    <span class="text-xs font-semibold text-gray-700 mt-1">{{ label|split_by_space|first }}</span>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>

            {# Mantﾃｩm o campo real do formulﾃ｡rio 'estado' oculto para submissﾃ｣o #}
            <div id="hidden-radio-widget" style="display: none;">{{ form.estado }}</div>

            {% if form.estado.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.estado.errors }}</div>
            {% endif %}
          </div>

          {# 3. CAMPO DE DESCRIﾃﾃグ #}
          <div id="description-container" class="mb-8" style="display: none;">
            <label for="id_descricaohumor" class="block text-xl font-semibold text-gray-700 mb-2">Nova Descriﾃｧﾃ｣o:</label>
            <textarea id="id_descricaohumor" name="descricaohumor" rows="8" placeholder="Descreva brevemente o que motivou seu humor hoje..." class="w-full p-4 border-2 border-green-200 rounded-xl focus:border-lyfesync-green focus:ring focus:ring-green-100 transition duration-150 custom-textarea"></textarea>

            {% if form.descricaohumor.errors %}
              <div class="text-red-500 text-sm mt-1">{{ form.descricaohumor.errors }}</div>
            {% endif %}
          </div>

          {# 4. BOTﾃグ SALVAR #}
          <div class="flex justify-end">
            <button type="submit" id="btn-salvar" class="btn-salvar-humor py-3 px-8 text-white font-bold rounded-xl shadow-lg transition duration-200" style="display: none;">SALVAR ALTERAﾃﾃ髭S</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Funﾃｧﾃｵes de Utilidade e Constantes
    const AJAX_LOAD_URL = "{% url 'load_humor_by_date' %}"
    const ALTERAR_URL_TEMPLATE = "{% url 'alterarHumor' humor_id=999999999 %}"
    const REGISTRAR_URL = "{% url 'registrarHumor' %}"
    
    // Elementos DOM
    const formElement = document.getElementById('form-alteracao-humor')
    const humorIdInput = document.getElementById('humor_id')
    const descriptionInput = document.getElementById('id_descricaohumor')
    const feedbackMessage = document.getElementById('feedback-message')
    const btnSalvar = document.getElementById('btn-salvar')
    const humorSelectionContainer = document.getElementById('humor-selection-container')
    const descriptionContainer = document.getElementById('description-container')
    const dateInput = document.getElementById('id_data')
    
    /**
     * Marca o humor selecionado no DOM e no campo de rﾃ｡dio oculto.
     */
    function selectHumor(humorValue, element) {
      // 1. Remove a classe de seleﾃｧﾃ｣o de todos os containers
      document.querySelectorAll('[data-humor-container]').forEach(function (el) {
        el.classList.remove('selected-humor')
      })
    
      // 2. Adiciona a classe de seleﾃｧﾃ｣o ao elemento clicado
      if (element) {
        element.classList.add('selected-humor')
      }
    
      // 3. Marca o input de rﾃ｡dio correspondente
      const radioInputs = document.querySelectorAll('input[name="estado"][type="radio"]')
      radioInputs.forEach(function (input) {
        input.checked = input.value === humorValue
      })
    }
    
    /**
     * Limpa e prepara os campos para novo registro/ediﾃｧﾃ｣o.
     * Seleciona o humor se os dados forem encontrados.
     */
    function handleDataDisplay(data, dateString) {
      // Limpa seleﾃｧﾃｵes antigas
      document.querySelectorAll('[data-humor-container]').forEach((el) => el.classList.remove('selected-humor'))
      document.querySelectorAll('input[name="estado"][type="radio"]').forEach((el) => (el.checked = false))
    
      // Mostra containers (Humor e Descriﾃｧﾃ｣o)
      humorSelectionContainer.style.display = 'block'
      descriptionContainer.style.display = 'block'
      btnSalvar.style.display = 'inline-block'
      descriptionInput.value = data.descricaohumor || '' // Preenche a descriﾃｧﾃ｣o se existir
    
      if (data.exists) {
        // MODO EDIﾃﾃグ
        humorIdInput.value = data.id
        formElement.action = ALTERAR_URL_TEMPLATE.replace('999999999', data.id)
        btnSalvar.textContent = 'SALVAR ALTERAﾃﾃ髭S'
        feedbackMessage.className = 'alert alert-success mt-4 p-3 bg-green-100 text-green-700 rounded'
        feedbackMessage.textContent = `Registro encontrado para ${dateString}. Vocﾃｪ pode alterﾃ｡-lo.`
    
        // 圷 Seleciona o ﾃｭcone de humor existente
        const selectedElement = document.querySelector(`[data-humor-value="${data.estado}"]`)
        if (selectedElement) {
          selectHumor(data.estado, selectedElement)
        } else {
          // Caso onde o humor salvo nﾃ｣o tem um ﾃｭcone correspondente no template
          selectHumor(data.estado, null)
          console.warn(`Aviso: O humor salvo '${data.estado}' foi marcado no rﾃ｡dio, mas o ﾃｭcone visual correspondente nﾃ｣o foi encontrado.`)
        }
      } else {
        // MODO NOVO REGISTRO
        humorIdInput.value = ''
        formElement.action = REGISTRAR_URL
        btnSalvar.textContent = 'REGISTRAR NOVO HUMOR'
        feedbackMessage.className = 'alert alert-info mt-4 p-3 bg-blue-100 text-blue-700 rounded'
        feedbackMessage.textContent = `Nenhum registro encontrado para ${dateString}. Vocﾃｪ pode criar um novo.`
      }
      feedbackMessage.style.display = 'block'
    }
    
    /**
     * Busca dados de humor via AJAX com base na data.
     */
    function loadHumorData(dateString) {
      // Limpa feedback e oculta elementos antes de carregar
      feedbackMessage.style.display = 'none'
      humorSelectionContainer.style.display = 'none'
      descriptionContainer.style.display = 'none'
      btnSalvar.style.display = 'none'
    
      if (!dateString) return
    
      console.log(`[AJAX] Buscando humor para a data: ${dateString}`)
    
      fetch(`${AJAX_LOAD_URL}?date=${dateString}`)
        .then((response) => {
          if (!response.ok) {
            console.error(`[AJAX ERROR] Falha na resposta do servidor. Status: ${response.status}`)
            throw new Error('Falha na resposta do servidor. (Status: ' + response.status + ')')
          }
          return response.json()
        })
        .then((data) => {
          console.log('[AJAX SUCCESS] Dados de humor recebidos:', data)
          handleDataDisplay(data, dateString)
        })
        .catch((error) => {
          console.error('Erro final na funﾃｧﾃ｣o loadHumorData:', error)
          feedbackMessage.className = 'alert alert-danger mt-4 p-3 bg-red-100 text-red-700 rounded'
          feedbackMessage.textContent = 'Ocorreu um erro ao tentar carregar o humor. Tente novamente e verifique o Console (F12) para detalhes.'
          feedbackMessage.style.display = 'block'
        })
    }
    
    // Inicializaﾃｧﾃ｣o no carregamento da pﾃ｡gina
    document.addEventListener('DOMContentLoaded', function () {
      const initialDate = dateInput.value
    
      if (!initialDate) {
        // Define a data de hoje se o campo estiver vazio
        const today = new Date()
        const todayString = today.toISOString().split('T')[0]
        dateInput.value = todayString
        loadHumorData(todayString)
      } else {
        // Carrega os dados para a data inicial (ﾃｺtil para POST com erro)
        loadHumorData(initialDate)
      }
    })
  </script>
{% endblock %}
