{# alterarHumor.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}

{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
  Alterar Humor
{% endblock %}

{% block content_logado %}
  {# Se este arquivo CSS não existir em static/css/ o botão continuará branco. #}
  <link rel="stylesheet" href="{% static 'css/homeLifesync.css' %}" />

  {# CORREÇÃO: Sistema de Mensagens Toast-like (Substitui o alert() proibido) #}
  <div id="django-messages-container" class="fixed-top p-3" style="z-index: 1050; pointer-events: none;">
      {% for message in messages %}
          {% with tags=message.tags %}
          {% comment %} Determina cores para as mensagens de feedback sem depender de classes específicas do Bootstrap que talvez não estejam no masterpage. {% endcomment %}
          <div id="message-{{ forloop.counter }}" 
               class="alert rounded-3 shadow-lg my-2 mx-auto d-flex align-items-center" 
               style="max-width: 90%; width: fit-content; pointer-events: all; padding: 1rem;
                      {% if 'success' in tags %}background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;{% elif 'error' in tags or 'warning' in tags %}background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7;{% else %}background-color: #cfe2ff; color: #084298; border: 1px solid #b9d1f5;{% endif %}">
              <span class="me-2 fw-bold">
                  {% if 'success' in tags %}✅{% elif 'error' in tags or 'warning' in tags %}❌{% else %}ℹ️{% endif %}
              </span>
              <span>{{ message }}</span>
          </div>
          {% endwith %}
      {% endfor %}
  </div>


  <div class="container p-4 p-md-5 mt-5">
    <div class="row g-4 justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 card p-4 p-lg-5 rounded-4 shadow-lg border-0">
        <h2 class="fw-bold mb-4 alterar-humor-title">Alterar Humor Registrado</h2>

        <form id="form-alteracao-humor" method="POST" action="{% url 'alterarHumor' humor_id=humor_id|default:0 %}">
          {% csrf_token %}

          {# Div de feedback de erro AJAX (mantida oculta por padrão) #}
          <div id="feedback-message" class="mb-4 d-none"></div>

          {# 1. SELEÇÃO DE DATA #}
          <div class="mb-4">
            <label for="id_data" class="form-label fw-semibold mb-2 form-label-lg">Selecione a Data para Edição:</label>

            <input type="date" id="id_data" name="data" class="form-control form-control-lg w-100 w-sm-50 date-input-border" value="{{ form.data.value|default_if_none:'' }}" required onchange="loadHumorData(this.value)" />
            <input type="hidden" name="humor_id" id="humor_id" value="{{ humor_id|default_if_none:'' }}" />
          </div>

          {# 2. SELEÇÃO DE HUMOR (RENDERIZADO PELO DJANGO) #}
          <div id="humor-selection-container" class="mb-4">
            <label class="form-label fw-semibold mb-3 form-label-lg">Novo Humor:</label>

            <div class="d-flex flex-wrap gap-3">
              {# Renderização direta dos ícones #}
              {% for value, label in form.estado.field.choices %}
                {% with image_path=humor_icon_class_map|get_item:value|default:'img/icon/adchumor.png' %}
                  <div class="humor-option-item cursor-pointer d-flex flex-column align-items-center justify-content-center text-center p-2 rounded-3 humor-option-item-transition" data-humor-container data-humor-value="{{ value }}" onclick="selectHumor('{{ value }}', this)">
                    {% if value %}
                      <img src="{% static image_path %}" alt="{{ label }}" class="humor-image" />
                    {% else %}
                      <img src="{% static 'img/icon/adchumor.png' %}" alt="{{ label }}" class="humor-image" />
                    {% endif %}
                    <small class="fw-semibold text-secondary mt-1">{{ label|split_by_space|first }}</small>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>

            {# Mantém o campo real do formulário 'estado' oculto para submissão #}
            <div id="hidden-radio-widget" class="d-none">{{ form.estado }}</div>

            {% if form.estado.errors %}
              <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
            {% endif %}
          </div>

          {# 3. CAMPO DE DESCRIÇÃO #}
          <div id="description-container" class="mb-4">
            <label for="id_descricaohumor" class="form-label fw-semibold mb-2 form-label-lg">Nova Descrição:</label>

            <textarea id="id_descricaohumor" name="descricaohumor" rows="8" placeholder="Descreva brevemente o que motivou seu humor hoje..." class="form-control custom-textarea p-4 description-textarea-border"></textarea>

            {% if form.descricaohumor.errors %}
              <div class="text-danger small mt-1">{{ form.descricaohumor.errors }}</div>
            {% endif %}
          </div>

          {# 4. BOTÃO SALVAR #}
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" id="btn-salvar" class="btn-salvar-humor btn btn-success btn-lg fw-bold rounded-4 shadow-sm btn-salvar-alterar-humor">SALVAR ALTERAÇÕES</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Funções de Utilidade e Constantes
    const AJAX_LOAD_URL = "{% url 'load_humor_by_date' %}"
    const ALTERAR_URL_TEMPLATE = "{% url 'alterarHumor' humor_id=999999999 %}"
    const REGISTRAR_URL = "{% url 'registrarHumor' %}"
    // Elementos DOM
    const formElement = document.getElementById('form-alteracao-humor')
    const humorIdInput = document.getElementById('humor_id')
    const descriptionInput = document.getElementById('id_descricaohumor')
    const feedbackMessage = document.getElementById('feedback-message')
    const btnSalvar = document.getElementById('btn-salvar')
    const humorSelectionContainer = document.getElementById('humor-selection-container')
    const descriptionContainer = document.getElementById('description-container')
    const dateInput = document.getElementById('id_data')
    
    /**
     * Marca o humor selecionado no DOM e no campo de rádio oculto.
     */
    function selectHumor(humorValue, element) {
      // 1. Remove a classe de seleção de todos os containers
      document.querySelectorAll('[data-humor-container]').forEach(function (el) {
        el.classList.remove('selected-humor')
      })
      // 2. Adiciona a classe de seleção ao elemento clicado
      if (element) {
        element.classList.add('selected-humor')
      }
      // 3. Marca o input de rádio correspondente
      const radioInputs = document.querySelectorAll('input[name="estado"][type="radio"]')
      radioInputs.forEach(function (input) {
        input.checked = input.value === humorValue
      })
    }
    
    /**
     * Limpa e prepara os campos para novo registro/edição.
     * Seleciona o humor se os dados forem encontrados.
     */
    function handleDataDisplay(data, dateString) {
      // Limpa seleções antigas
      document.querySelectorAll('[data-humor-container]').forEach((el) => el.classList.remove('selected-humor'))
      document.querySelectorAll('input[name="estado"][type="radio"]').forEach((el) => (el.checked = false))
    
      // Mostra containers (Humor e Descrição)
      humorSelectionContainer.style.display = 'block'
      descriptionContainer.style.display = 'block'
      btnSalvar.style.display = 'inline-block'
    
      descriptionInput.value = data.descricaohumor || '' // Preenche a descrição se existir
    
      if (data.exists) {
        // MODO EDIÇÃO
        humorIdInput.value = data.id
        formElement.action = ALTERAR_URL_TEMPLATE.replace('999999999', data.id)
        btnSalvar.textContent = 'SALVAR ALTERAÇÕES'
    
        // Seleciona o ícone de humor existente
        const selectedElement = document.querySelector(`[data-humor-value="${data.estado}"]`)
        if (selectedElement) {
          selectHumor(data.estado, selectedElement)
        } else {
          selectHumor(data.estado, null)
          console.warn(`Aviso: O humor salvo '${data.estado}' foi marcado no rádio, mas o ícone visual correspondente não foi encontrado.`)
        }
      } else {
        // MODO NOVO REGISTRO
        humorIdInput.value = ''
        formElement.action = REGISTRAR_URL
        btnSalvar.textContent = 'REGISTRAR NOVO HUMOR'
    
        // Garante que a descrição e a seleção de humor estão limpas para novo registro
        descriptionInput.value = ''
        selectHumor('', null)
      }
      // Garante que a div de feedback de erro de AJAX esteja oculta, a menos que haja um erro de rede
      feedbackMessage.style.display = 'none'
    }
    
    /**
     * Busca dados de humor via AJAX com base na data.
     */
    function loadHumorData(dateString) {
      // Limpa feedback e oculta elementos antes de carregar
      feedbackMessage.style.display = 'none'
      humorSelectionContainer.style.display = 'none'
      descriptionContainer.style.display = 'none'
      btnSalvar.style.display = 'none'
    
      if (!dateString) return
    
      console.log(`[AJAX] Buscando humor para a data: ${dateString}`)
    
      fetch(`${AJAX_LOAD_URL}?date=${dateString}`)
        .then((response) => {
          if (!response.ok) {
            console.error(`[AJAX ERROR] Falha na resposta do servidor. Status: ${response.status}`)
            throw new Error('Falha na resposta do servidor. (Status: ' + response.status + ')')
          }
          return response.json()
        })
        .then((data) => {
          console.log('[AJAX SUCCESS] Dados de humor recebidos:', data)
          handleDataDisplay(data, dateString)
        })
        .catch((error) => {
          console.error('Erro final na função loadHumorData:', error)
          // Se o AJAX falhar, mostra uma mensagem de erro na div feedback.
          feedbackMessage.className = 'alert alert-danger mt-4 p-3'
          feedbackMessage.textContent = 'Ocorreu um erro ao tentar carregar o humor. Tente novamente.'
          feedbackMessage.style.display = 'block'
    
          humorSelectionContainer.style.display = 'none'
          descriptionContainer.style.display = 'none'
          btnSalvar.style.display = 'none'
        })
    }

    /**
     * Função para mostrar e desvanecer as mensagens do Django (Substitui o alert())
     */
    function showAndFadeMessages() {
        const messageContainer = document.getElementById('django-messages-container');
        if (messageContainer) {
            const messages = messageContainer.querySelectorAll('.alert');
            messages.forEach(message => {
                // Após 5 segundos, inicia o desvanecimento
                setTimeout(() => {
                    message.style.transition = 'opacity 1s ease-out';
                    message.style.opacity = '0';
                }, 5000);

                // Remove do DOM após a transição
                setTimeout(() => {
                    message.remove();
                }, 6000);
            });

            // Limpa o histórico da URL se houver mensagens (para prevenir reenvio do form)
            if (messages.length > 0 && window.history.replaceState) {
                try {
                    window.history.replaceState(null, null, window.location.pathname);
                } catch (e) {
                    // Captura o SecurityError que ocorre em alguns ambientes (ex: iframes com URLs blob:)
                    console.error("Erro ao limpar o estado do histórico (pode ser devido a restrições de segurança do iframe):", e.message);
                }
            }
        }
    }
    
    // Inicialização no carregamento da página
    document.addEventListener('DOMContentLoaded', function () {
      // 1. Inicia o sistema de mensagens (substituindo o antigo bloco extra_js)
      showAndFadeMessages();

      // 2. Carrega os dados do humor para a data inicial
      const initialDate = dateInput.value
    
      if (!initialDate) {
        // Define a data de hoje se o campo estiver vazio
        const today = new Date()
        const todayString = today.toISOString().split('T')[0]
        dateInput.value = todayString
        loadHumorData(todayString)
      } else {
        // Carrega os dados para a data inicial (útil para POST com erro)
        loadHumorData(initialDate)
      }
    })
  </script>
{% endblock %}