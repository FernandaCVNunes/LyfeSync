{# alterarHumor.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
Alterar Humor
{% endblock %}

{% block content_logado %}
{# É crucial que as classes como .rs-form-control, .humor-image-lg, .humor-option-card.active, .btn-salvar-form estejam
definidas em homeLyfesync.css #}
<link rel="stylesheet" href="{% static 'css/homeLyfesync.css' %}">

<div class="container py-4 py-md-5">
  <div class="row justify-content-center">
    {# Coluna Principal do Formulário - Ocupa toda a largura, centralizado #}
    <div class="col-12 col-lg-8 card p-4 p-md-5 rounded-4 shadow-lg border-0 bg-white">

              <h2 class="fw-bold mb-4 humor-title text-center text-lg-start">
                    Edite seu humor registrado:
                </h2>

              <!-- Mensagens do Django (Necessita de Bootstrap JS para fechar o alert) -->
              {% if messages %}
                  <div class="mb-4">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                  {{ message }}
                                  <button type="button" class="btn-close" data-bs-dismiss="alert"
            aria-label="Close"></button>
                              </div>
                        {% endfor %}
                    </div>
              {% endif %}

              {# AÇÃO FIXA: Sempre a URL de alteração com o PK da instância #}
              <form id="form-registro-humor"             method="POST"            
        action="{% url 'alterarHumor' humor_id=form.instance.pk %}">
                    {% csrf_token %}
                 
                    {# Campo de Data - Tornamos a data somente leitura (read-only) em modo edição #}
                    <div class="mb-4">
                          <label for="{{ form.data.id_for_label }}"
            class="form-label h5 fw-semibold text-secondary mb-2">{{ form.data.label }}:</label>
                          {# Aplicamos a classe rs-form-control e garantimos que é read-only #}
                          <input type="date" name="data" id="{{ form.data.id_for_label }}"                      
             class="form-control rs-form-control"                        value="{{ form.data.value|date:'Y-m-d' }}"    
                               readonly />
                         
                          {# Exibimos erros de data, se houver #}
                          {% if form.data.errors %}
                              <div class="text-danger small mt-1">{{ form.data.errors }}</div>
                          {% endif %}
                      </div>

                    {# ------------------------------------------------------------------- #}
                    {# CAMPO 'ESTADO' (Seleção Visual de Humor) #}
                    {# ------------------------------------------------------------------- #}
                    <div class="mb-4">
                          <label class="form-label h5 fw-semibold text-secondary mb-3">{{ form.estado.label }}</label>

                          {# 1. INPUT HIDDEN REAL: Este campo envia o PK do humor selecionado #}
                          <input type="hidden"                         name="estado"                        
            id="id_estado"                        
            value="{% if form.instance.estado.pk %}{{ form.instance.estado.pk }}{% endif %}" />
                         
                          {# 2. Exibe Erros do Campo #}
                          {% if form.estado.errors %}
                              <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
                          {% endif %}

                          {# Grade de Seleção Visual de Humor #}
                          <div class="d-flex flex-wrap justify-content-center gap-3 humor-grid" role="radiogroup"
            aria-labelledby="id_estado_label">
                                {% for tipo in humores_disponiveis %}
                                    {% with image_path=tipo.icone|default:'img/icon/adchumor.png' %}
                                        {# CORREÇÃO APLICADA AQUI: Incorporando a classe &#39;active&#39; na linha do
            atributo class #}
                                        <div
              class="humor-option-card {% if form.instance.estado.pk == tipo.pk %}active{% endif %}"                    
                          data-humor-container                                 data-humor-value="{{ tipo.pk }}"        
                                      onclick="selectHumor('{{ tipo.pk }}', this)"                                
              tabindex="0"                                 role="radio"                                
              aria-checked="{% if form.instance.estado.pk == tipo.pk %}true{% else %}false{% endif %}"                  
                           >
                                              <img src="{% static image_path %}" alt="{{ tipo.estado }}"
                class="humor-image-lg" />
                                              <span class="humor-label">{{ tipo.estado }}</span>
                                          </div>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                      </div>

                    {# Campo 'descricaohumor' #}
                    <div class="mb-4">
                          <label for="{{ form.descricaohumor.id_for_label }}"
            class="form-label h5 fw-semibold text-secondary mb-2">{{ form.descricaohumor.label }}:</label>
                          {# Renderiza o campo de textarea. Garantimos a classe rs-form-control #}
                          <textarea name="descricaohumor" id="{{ form.descricaohumor.id_for_label }}" rows="5"
            class="form-control rs-form-control">{{ form.descricaohumor.value|default_if_none:'' }}</textarea>

                          {% if form.descricaohumor.errors %}
                              <div class="text-danger small mt-1">{{ form.descricaohumor.errors }}</div>
                          {% endif %}
                      </div>

                    <div class="d-flex justify-content-end mt-4">
                          <button type="submit" class="btn btn-salvar-form text-white fw-bold rounded-3 shadow-lg">
                                SALVAR ALTERAÇÕES
                            </button>
                      </div>
                </form>
          </div>
  </div>
</div>
<script>
  // Função JavaScript para gerenciar a seleção de humor
  function selectHumor(humorValue, element) {
    // Garante que o valor de comparação é sempre uma string
    const val = String(humorValue);

    // 1. Remove a classe de seleção de todos os containers
    document.querySelectorAll('[data-humor-container]').forEach(function (el) {
      el.classList.remove('active'); // 'active' é a classe customizada para o estado selecionado
      el.setAttribute('aria-checked', 'false');
    });

    // 2. Adiciona a classe de seleção ao elemento clicado (se houver)
    if (element) {
      element.classList.add('active');
      element.setAttribute('aria-checked', 'true');
    }

    // 3. ATUALIZA O INPUT HIDDEN REAL
    const hiddenInput = document.getElementById('id_estado');
    if (hiddenInput) {
      hiddenInput.value = val;
    } else {
      console.error("Erro: Input hidden 'id_estado' não encontrado!");
    }
  }
  // NOTA: A lógica de pré-seleção no DOMContentLoaded foi removida,
  // pois o Django agora aplica a classe &#39;active&#39; diretamente ao elemento
  // correto durante a renderização inicial do template.
</script>
{% endblock %}