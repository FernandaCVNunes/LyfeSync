{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
  Alterar Humor
{% endblock %}

{% block content_logado %}
  {# Se este arquivo CSS n√£o existir em static/css/ o bot√£o continuar√° branco. #}
  <link rel="stylesheet" href="{% static 'css/homeLifesync.css' %}" />

  <div id="django-messages-container">
    {% if messages %}
      {% for message in messages %}
        {% if 'success' in message.tags %}
          <span data-message-type="success" data-message-text="‚úÖ {{ message }}"></span>
        {% elif 'error' in message.tags or 'warning' in message.tags %}
          <span data-message-type="error" data-message-text="‚ùå {{ message }}"></span>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

  <div class="container p-4 p-md-5 mt-5">
    <div class="row g-4 justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 card p-4 p-lg-5 rounded-4 shadow-lg border-0">
        <h2 class="fw-bold mb-4 alterar-humor-title">Alterar Humor Registrado</h2>

        <form id="form-alteracao-humor" method="POST" action="{% url 'alterarHumor' humor_id=humor_id|default:0 %}">
          {% csrf_token %}

          {# Div de feedback de erro AJAX (mantida oculta por padr√£o) #}
          <div id="feedback-message" class="mb-4 d-none"></div>

          {# 1. SELE√á√ÉO DE DATA #}
          <div class="mb-4">
            <label for="id_data" class="form-label fw-semibold mb-2 form-label-lg">Selecione a Data para Edi√ß√£o:</label>

            <input type="date" id="id_data" name="data" class="form-control form-control-lg w-100 w-sm-50 date-input-border" value="{{ form.data.value|default_if_none:'' }}" required onchange="loadHumorData(this.value)" />
            <input type="hidden" name="humor_id" id="humor_id" value="{{ humor_id|default_if_none:'' }}" />
          </div>

          {# 2. SELE√á√ÉO DE HUMOR (RENDERIZADO PELO DJANGO) #}
          <div id="humor-selection-container" class="mb-4">
            <label class="form-label fw-semibold mb-3 form-label-lg">Novo Humor:</label>

            <div class="d-flex flex-wrap gap-3">
              {# Renderiza√ß√£o direta dos √≠cones #}
              {% for value, label in form.estado.field.choices %}
                {% with image_path=humor_icon_class_map|get_item:value|default:'img/icon/adchumor.png' %}
                  <div class="humor-option-item cursor-pointer d-flex flex-column align-items-center justify-content-center text-center p-2 rounded-3 humor-option-item-transition" data-humor-container data-humor-value="{{ value }}" onclick="selectHumor('{{ value }}', this)">
                    {% if value %}
                      <img src="{% static image_path %}" alt="{{ label }}" class="humor-image" />
                    {% else %}
                      <img src="{% static 'img/icon/adchumor.png' %}" alt="{{ label }}" class="humor-image" />
                    {% endif %}
                    <small class="fw-semibold text-secondary mt-1">{{ label|split_by_space|first }}</small>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>

            {# Mant√©m o campo real do formul√°rio 'estado' oculto para submiss√£o #}
            <div id="hidden-radio-widget" class="d-none">{{ form.estado }}</div>

            {% if form.estado.errors %}
              <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
            {% endif %}
          </div>

          {# 3. CAMPO DE DESCRI√á√ÉO #}
          <div id="description-container" class="mb-4">
            <label for="id_descricaohumor" class="form-label fw-semibold mb-2 form-label-lg">Nova Descri√ß√£o:</label>

            <textarea id="id_descricaohumor" name="descricaohumor" rows="8" placeholder="Descreva brevemente o que motivou seu humor hoje..." class="form-control custom-textarea p-4 description-textarea-border"></textarea>

            {% if form.descricaohumor.errors %}
              <div class="text-danger small mt-1">{{ form.descricaohumor.errors }}</div>
            {% endif %}
          </div>

          {# 4. BOT√ÉO SALVAR #}
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" id="btn-salvar" class="btn-salvar-humor btn btn-success btn-lg fw-bold rounded-4 shadow-sm btn-salvar-alterar-humor">SALVAR ALTERA√á√ïES</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Fun√ß√µes de Utilidade e Constantes
    const AJAX_LOAD_URL = "{% url 'load_humor_by_date' %}"
    const ALTERAR_URL_TEMPLATE = "{% url 'alterarHumor' humor_id=999999999 %}"
    const REGISTRAR_URL = "{% url 'registrarHumor' %}"
    // Elementos DOM
    const formElement = document.getElementById('form-alteracao-humor')
    const humorIdInput = document.getElementById('humor_id')
    const descriptionInput = document.getElementById('id_descricaohumor')
    const feedbackMessage = document.getElementById('feedback-message')
    const btnSalvar = document.getElementById('btn-salvar')
    const humorSelectionContainer = document.getElementById('humor-selection-container')
    const descriptionContainer = document.getElementById('description-container')
    const dateInput = document.getElementById('id_data')
    
    /**
     * Marca o humor selecionado no DOM e no campo de r√°dio oculto.
     */
    function selectHumor(humorValue, element) {
      // 1. Remove a classe de sele√ß√£o de todos os containers
      document.querySelectorAll('[data-humor-container]').forEach(function (el) {
        el.classList.remove('selected-humor')
      })
      // 2. Adiciona a classe de sele√ß√£o ao elemento clicado
      if (element) {
        element.classList.add('selected-humor')
      }
      // 3. Marca o input de r√°dio correspondente
      const radioInputs = document.querySelectorAll('input[name="estado"][type="radio"]')
      radioInputs.forEach(function (input) {
        input.checked = input.value === humorValue
      })
    }
    
    /**
     * Limpa e prepara os campos para novo registro/edi√ß√£o.
     * Seleciona o humor se os dados forem encontrados.
     */
    function handleDataDisplay(data, dateString) {
      // Limpa sele√ß√µes antigas
      document.querySelectorAll('[data-humor-container]').forEach((el) => el.classList.remove('selected-humor'))
      document.querySelectorAll('input[name="estado"][type="radio"]').forEach((el) => (el.checked = false))
    
      // Mostra containers (Humor e Descri√ß√£o)
      humorSelectionContainer.style.display = 'block'
      descriptionContainer.style.display = 'block'
      btnSalvar.style.display = 'inline-block'
    
      descriptionInput.value = data.descricaohumor || '' // Preenche a descri√ß√£o se existir
    
      if (data.exists) {
        // MODO EDI√á√ÉO
        humorIdInput.value = data.id
        formElement.action = ALTERAR_URL_TEMPLATE.replace('999999999', data.id)
        btnSalvar.textContent = 'SALVAR ALTERA√á√ïES'
    
        // üö® Seleciona o √≠cone de humor existente
        const selectedElement = document.querySelector(`[data-humor-value="${data.estado}"]`)
        if (selectedElement) {
          selectHumor(data.estado, selectedElement)
        } else {
          selectHumor(data.estado, null)
          console.warn(`Aviso: O humor salvo '${data.estado}' foi marcado no r√°dio, mas o √≠cone visual correspondente n√£o foi encontrado.`)
        }
      } else {
        // MODO NOVO REGISTRO
        humorIdInput.value = ''
        formElement.action = REGISTRAR_URL
        btnSalvar.textContent = 'REGISTRAR NOVO HUMOR'
    
        // Garante que a descri√ß√£o e a sele√ß√£o de humor est√£o limpas para novo registro
        descriptionInput.value = ''
        selectHumor('', null)
      }
      // Garante que a div de feedback de erro de AJAX esteja oculta, a menos que haja um erro de rede
      feedbackMessage.style.display = 'none'
    }
    
    /**
     * Busca dados de humor via AJAX com base na data.
     */
    function loadHumorData(dateString) {
      // Limpa feedback e oculta elementos antes de carregar
      feedbackMessage.style.display = 'none'
      humorSelectionContainer.style.display = 'none'
      descriptionContainer.style.display = 'none'
      btnSalvar.style.display = 'none'
    
      if (!dateString) return
    
      console.log(`[AJAX] Buscando humor para a data: ${dateString}`)
    
      fetch(`${AJAX_LOAD_URL}?date=${dateString}`)
        .then((response) => {
          if (!response.ok) {
            console.error(`[AJAX ERROR] Falha na resposta do servidor. Status: ${response.status}`)
            throw new Error('Falha na resposta do servidor. (Status: ' + response.status + ')')
          }
          return response.json()
        })
        .then((data) => {
          console.log('[AJAX SUCCESS] Dados de humor recebidos:', data)
          handleDataDisplay(data, dateString)
        })
        .catch((error) => {
          console.error('Erro final na fun√ß√£o loadHumorData:', error)
          // Se o AJAX falhar, mostra uma mensagem de erro na div feedback.
          feedbackMessage.className = 'alert alert-danger mt-4 p-3'
          feedbackMessage.textContent = 'Ocorreu um erro ao tentar carregar o humor. Tente novamente.'
          feedbackMessage.style.display = 'block'
    
          humorSelectionContainer.style.display = 'none'
          descriptionContainer.style.display = 'none'
          btnSalvar.style.display = 'none'
        })
    }
    
    // Inicializa√ß√£o no carregamento da p√°gina
    document.addEventListener('DOMContentLoaded', function () {
      const initialDate = dateInput.value
    
      if (!initialDate) {
        // Define a data de hoje se o campo estiver vazio
        const today = new Date()
        const todayString = today.toISOString().split('T')[0]
        dateInput.value = todayString
        loadHumorData(todayString)
      } else {
        // Carrega os dados para a data inicial (√∫til para POST com erro)
        loadHumorData(initialDate)
      }
    })
  </script>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const messageElements = document.querySelectorAll('#django-messages-container [data-message-type]')
      messageElements.forEach(function (el) {
        const messageText = el.getAttribute('data-message-text')
        if (messageText) {
          alert(messageText)
        }
      })
      // Limpar a URL ap√≥s o alerta (boa pr√°tica)
      if (messageElements.length > 0 && window.history.replaceState) {
        window.history.replaceState(null, null, window.location.pathname)
      }
    })
  </script>
{% endblock %}
