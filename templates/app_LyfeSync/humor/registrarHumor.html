{# registrarHumor.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
{% if form.instance.pk %}
Alterar Humor
{% else %}
Registrar Humor
{% endif %}
{% endblock %}

{% block content_logado %}

{# É crucial que as classes como .rs-form-control, .humor-image-lg, .humor-option-card.active, .btn-salvar-form estejam definidas em homeLyfesync.css #}
<link rel="stylesheet" href="{% static 'css/homeLyfesync.css' %}">

<div class="container py-4 py-md-5">
    <div class="row justify-content-center">
        {# Coluna Principal do Formulário - Ocupa toda a largura, centralizado #}
        <div class="col-12 col-lg-8 card p-4 p-md-5 rounded-4 shadow-lg border-0 bg-white">
            
            <h2 class="fw-bold mb-4 humor-title text-center text-lg-start">
                {% if form.instance.pk %}
                    Edite seu humor registrado:
                {% else %}
                    Como você está se sentindo hoje?
                {% endif %}
            </h2>

            <!-- Mensagens do Django (Necessita de Bootstrap JS para fechar o alert) -->
            {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {# AÇÃO DINÂMICA: Verifica se é uma edição ou um novo registro #}
            <form id="form-registro-humor"
                method="POST"
                action="{% if form.instance.pk %}
                    {% url 'alterarHumor' humor_id=form.instance.pk %}
                {% else %}
                    {% url 'registrarHumor' %}
                {% endif %}">
                {% csrf_token %}
              
                {# Campo de Data #}
                <div class="mb-4">
                    <label for="{{ form.data.id_for_label }}" class="form-label h5 fw-semibold text-secondary mb-2">{{ form.data.label }}:</label>
                    {{ form.data }} 
                    
                    {% if form.data.errors %}
                        <div class="text-danger small mt-1">{{ form.data.errors }}</div>
                    {% endif %}
                </div>

                {# ------------------------------------------------------------------- #}
                {# CAMPO 'ESTADO' CORRIGIDO: Agora usa um input hidden simples #}
                {# ------------------------------------------------------------------- #}
                <div class="mb-4">
                    <label class="form-label h5 fw-semibold text-secondary mb-3">{{ form.estado.label }}</label>

                    {# 1. INPUT HIDDEN REAL: Este campo envia o PK do humor selecionado #}
                    {# Importante: O nome deve ser 'estado' e o ID 'id_estado' #}
                    <input type="hidden" 
                           name="estado" 
                           id="id_estado" 
                           value="{% if form.instance.estado.pk %}{{ form.instance.estado.pk }}{% endif %}" />
                    
                    {# 2. Exibe Erros do Campo (usa o objeto form.estado para isso) #}
                    {% if form.estado.errors %}
                        <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
                    {% endif %}

                    {# Grade de Seleção Visual de Humor (HTML puramente visual) #}
                    <div class="d-flex flex-wrap justify-content-center gap-3 humor-grid" role="radiogroup" aria-labelledby="id_estado_label">
                        {% for tipo in humores_disponiveis %}
                            {% with image_path=tipo.icone|default:'img/icon/adchumor.png' %}
                                <div class="humor-option-card" 
                                    data-humor-container 
                                    data-humor-value="{{ tipo.pk }}" 
                                    onclick="selectHumor('{{ tipo.pk }}', this)"
                                    tabindex="0"
                                    role="radio"
                                    aria-checked="{% if form.instance.estado.pk == tipo.pk %}true{% else %}false{% endif %}"
                                    >
                                    <img src="{% static image_path %}" alt="{{ tipo.estado }}" class="humor-image-lg" />
                                    <span class="humor-label">{{ tipo.estado }}</span>
                                </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>

                {# Campo 'descricaohumor' #}
                <div class="mb-4">
                    <label for="{{ form.descricaohumor.id_for_label }}" class="form-label h5 fw-semibold text-secondary mb-2">{{ form.descricaohumor.label }}:</label>
                    {{ form.descricaohumor }}

                    {% if form.descricaohumor.errors %}
                        <div class="text-danger small mt-1">{{ form.descricaohumor.errors }}</div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-salvar-form text-white fw-bold rounded-3 shadow-lg">
                        SALVAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função JavaScript para gerenciar a seleção de humor
function selectHumor(humorValue, element) {
    // Garante que o valor de comparação é sempre uma string
    const val = String(humorValue);

    // 1. Remove a classe de seleção de todos os containers
    document.querySelectorAll('[data-humor-container]').forEach(function (el) {
        el.classList.remove('active'); // 'active' é a classe customizada para o estado selecionado
        el.setAttribute('aria-checked', 'false');
    });
    
    // 2. Adiciona a classe de seleção ao elemento clicado
    element.classList.add('active');
    element.setAttribute('aria-checked', 'true');
    
    // 3. ATUALIZA O INPUT HIDDEN REAL
    const hiddenInput = document.getElementById('id_estado');
    if (hiddenInput) {
        hiddenInput.value = val;
    } else {
        console.error("Erro: Input hidden 'id_estado' não encontrado!");
    }
}

document.addEventListener('DOMContentLoaded', function () {
    // ------------------------------------------------------------------ 
    // Lógica de Pré-Seleção e Marcação Inicial (Para modo Alterar)
    // ------------------------------------------------------------------ 
    
    // Pega o valor inicial do input hidden (definido no Django/template)
    const hiddenInput = document.getElementById('id_estado');
    const preSelectedValue = hiddenInput ? hiddenInput.value : null;

    // Inicializa o estilo do container selecionado
    if (preSelectedValue) {
        // Usa o atributo data-humor-value (que contém o PK/ID)
        const initialElement = document.querySelector(`[data-humor-value="${String(preSelectedValue)}"]`);
        if (initialElement) {
            // Adiciona o CSS 'active' para visualização e o status ARIA
            initialElement.classList.add('active');
            initialElement.setAttribute('aria-checked', 'true');
        }
    } else {
        // Garante que não haja seleção visual para novos registros
        document.querySelectorAll('[data-humor-container]').forEach(el => {
            el.classList.remove('active');
            el.setAttribute('aria-checked', 'false');
        });
    }
});
</script>

{% endblock %}