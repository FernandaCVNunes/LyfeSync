{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %} 
{% load app_LyfeSync_extras %}

{% block title %}Meus Hábitos{% endblock %}

{% block extra_head %}
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                        <h6 class="text-white text-capitalize ps-3">Minha Tabela de Hábitos</h6>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">
                    
                    {# BOTÕES DE AÇÃO #}
                    <div class="d-flex justify-content-end p-3">
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#registrarHabitoModal">Novo Hábito</button>
                        <button type="button" class="btn btn-warning me-2" onclick="abrirModalAlterar()">Alterar Selecionado</button>
                        <button type="button" class="btn btn-danger" onclick="excluirHabitosSelecionados()">Excluir Selecionado</button>
                    </div>

                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Hábito</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Frequência</th>
                                    
                                    {# Cabeçalho dos 7 dias #}
                                    {% for date, day_name in last_7_days_dict.items %}
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                            {{ day_name }} 
                                            {% if date|date:"Y-m-d" == today_date|date:"Y-m-d" %}<span class="badge bg-primary">Hoje</span>{% endif %}
                                        </th>
                                    {% endfor %}
                                    <th class="text-secondary opacity-7"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {# Itera sobre a lista de hábitos do contexto #}
                                {% for habit in habits %}
                                <tr class="habit-row" onclick="selectHabitRow(event, {{ habit.id }})">
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ habit.nome }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ habit.descricao|default:"Sem descrição." }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">{{ habit.frequencia }}</p>
                                    </td>
                                    
                                    {# Células de Status Diário #}
                                    {% for date, day_name in last_7_days_dict.items %}
                                    <td class="align-middle text-center text-sm" onclick="toggleHabitDay({{ habit.id }}, '{{ date|date:"Y-m-d" }}', event)">
                                        
                                        {% with status_key=date|date:"Y-m-d" %}
                                            {# CORREÇÃO: Usa a notação de ponto para acessar o dicionário 'completion_status' #}
                                            {# Você deve garantir que a views.py envie 'completion_status' como um dicionário de datas (formato Y-m-d) para True/False #}
                                            {% if habit.completion_status.status_key %}
                                                <div class="check-box checked"></div>
                                            {% else %}
                                                <div class="check-box"></div>
                                            {% endif %}
                                        {% endwith %}
                                        
                                    </td>
                                    {% endfor %}

                                    <td class="align-middle">
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-secondary text-sm">Nenhum hábito registrado. Clique em 'Novo Hábito' para começar.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ------------------------------------------------------------------- #}
{# INCLUSÃO DO MODAL DE REGISTRO DE HÁBITO (Conteúdo original do registrarHabito.html) #}
{# O ID #registrarHabitoModal é referenciado pelo botão "Novo Hábito" acima. #}
{# ------------------------------------------------------------------- #}
<div class="modal fade" id="registrarHabitoModal" tabindex="-1" aria-labelledby="registrarHabitoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-custom">
            
            {# Cabeçalho do Modal #}
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title modal-title-custom" id="registrarHabitoLabel">Novo Hábito</h5>
                {# Botão de fechar (X) no canto superior direito #}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            
            {# Corpo do Modal - Formulário #}
            <div class="modal-body">
                <form method="POST" action="{% url 'registrar_habito' %}">
                    {% csrf_token %}
                    
                    {# Nome do Hábito (Linha 1) #}
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="nomeHabito" class="form-label visually-hidden">Nome do Hábito</label>
                            <input type="text" class="form-control form-control-custom" id="nomeHabito" name="nome_habito" placeholder="Nome do Hábito" required>
                        </div>
                    </div>

                    {# Data de Início e Fim (Linha 2) #}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dataInicio" class="form-label visually-hidden">Data de Início</label>
                            <input type="date" class="form-control form-control-custom" id="dataInicio" name="data_inicio" placeholder="Data de Início" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dataFim" class="form-label visually-hidden">Data de Fim</label>
                            <input type="date" class="form-control form-control-custom" id="dataFim" name="data_fim" placeholder="Data de Fim">
                        </div>
                    </div>

                    {# Quantidade e Frequência (Linha 3) #}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quantidade" class="form-label visually-hidden">Quantidade</label>
                            <input type="number" class="form-control form-control-custom" id="quantidade" name="quantidade" placeholder="Quantidade" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="frequencia" class="form-label visually-hidden">Frequência</label>
                            <select class="form-select form-control-custom" id="frequencia" name="frequencia" required>
                                <option value="" disabled selected>Frequência</option>
                                <option value="diario">Diária</option>
                                <option value="semanal">Semanal</option>
                                <option value="mensal">Mensal</option>
                            </select>
                        </div>
                    </div>

                    {# Unidade (Linha 4) #}
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="unidade" class="form-label visually-hidden">Unidade</label>
                            <input type="text" class="form-control form-control-custom" id="unidade" name="unidade" placeholder="Unidade (Ex: vezes, minutos, páginas)">
                        </div>
                    </div>
                    
                    {# Alvo (Linha 5) #}
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="alvo" class="form-label visually-hidden">Alvo</label>
                            <input type="text" class="form-control form-control-custom" id="alvo" name="alvo" placeholder="Alvo (Opcional)">
                        </div>
                    </div>

                    {# Descrição (Linha 6) #}
                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="descricao" class="form-label visually-hidden">Descrição</label>
                            <textarea class="form-control form-control-custom" id="descricao" name="descricao" rows="3" placeholder="Descrição"></textarea>
                        </div>
                    </div>

                    {# Botão Adicionar #}
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-adicionar-habito">Adicionar</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
    // Armazena o ID do hábito atualmente selecionado
    let selectedHabitId = null;

    /*
     * Função auxiliar para obter o CSRF Token do Django.
     */
    function getCsrfToken() {
        // Assume que o token está disponível via cookie ou tag no HTML
        const tokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return tokenElement ? tokenElement.value : '';
    }

    /**
     * Alterna o status de conclusão de um hábito para um dia específico via API.
     */
    async function toggleHabitDay(habitId, day, event) {
        event.stopPropagation(); // Impede a seleção da linha ao clicar no checkbox

        const checkbox = event.currentTarget.querySelector('.check-box');
        const isCurrentlyChecked = checkbox.classList.contains('checked');
        const action = isCurrentlyChecked ? 'uncheck' : 'check'; // Define a ação antes de alternar

        // Otimismo UI: Altera o estado visual imediatamente
        checkbox.classList.toggle('checked');
        
        try {
            // Usa a URL configurada no urls.py com o nome 'toggle_habit_day'
            const response = await fetch(`/habitos/toggle_day/${habitId}/${day}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ action: action }) 
            });

            if (!response.ok) {
                // Reverte o estado visual se o servidor retornar um erro
                checkbox.classList.toggle('checked'); 
                throw new Error('Falha ao atualizar o hábito no servidor.');
            }

            const data = await response.json();
            console.log('Resposta do servidor:', data);

        } catch (error) {
            console.error('Erro no toggleHabitDay:', error);
            alert('Erro: Não foi possível conectar com o servidor. Tente novamente.');
        }
    }
    
    /**
     * Função para selecionar (destacar) a linha de um hábito.
     */
    function selectHabitRow(event, habitId) {
        // Encontra todos os elementos de linha de hábito
        const allRows = document.querySelectorAll('.habit-row');
        allRows.forEach(row => row.classList.remove('selected'));

        // Encontra o elemento 'contents' que é o pai da linha clicada
        const rowElement = event.currentTarget.closest('.habit-row');
        
        if (rowElement) {
            rowElement.classList.add('selected');
            selectedHabitId = habitId;
        } else {
            selectedHabitId = null;
        }
    }

    /**
     * Exclui um único hábito e recarrega a página.
     */
    async function excluirHabito(habitId) {
        if (!confirm('Tem certeza que deseja excluir permanentemente este hábito?')) {
            return;
        }
        
        try {
            // Usa a URL configurada no urls.py com o nome 'delete_habit'
            const response = await fetch(`/habitos/delete/${habitId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (!response.ok) {
                throw new Error('Falha ao excluir o hábito no servidor.');
            }

            // Se for bem-sucedido, recarrega a página para atualizar a lista
            alert('Hábito excluído com sucesso! A página será recarregada.');
            window.location.reload(); 

        } catch (error) {
            console.error('Erro no excluirHabito:', error);
            alert('Erro: Não foi possível excluir o hábito.');
        }
    }


    // --- Funções para Ações (Novo, Excluir, Alterar) ---

    /**
     * Lógica para lidar com a exclusão do hábito selecionado.
     */
    function excluirHabitosSelecionados() {
        if (!selectedHabitId) {
            alert('Selecione um hábito na grade para poder excluí-lo.');
            return;
        }

        if (confirm(`Tem certeza que deseja excluir o hábito selecionado? (ID: ${selectedHabitId})`)) {
            excluirHabito(selectedHabitId);
        }
    }

    /**
     * Abre o modal de alteração para o hábito selecionado.
     */
    function abrirModalAlterar() {
        if (!selectedHabitId) {
            alert('Selecione um hábito na grade para poder alterá-lo.');
            return;
        }

        // Em uma implementação completa, você faria um FETCH para buscar os dados do hábito
        // e abriria um modal de edição diferente do modal de registro.
        alert(`Funcionalidade: Abrindo modal para alterar o Hábito ID ${selectedHabitId}. (Implementação pendente)`);
        
        // Exemplo: Redirecionar para uma URL de alteração (se houver)
        // window.location.href = `{% url 'alterar_habito' 0 %}`.replace('0', selectedHabitId);
    }
</script>
{% endblock extra_js %}