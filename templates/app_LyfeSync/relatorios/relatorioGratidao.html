{#relatórioGratidao.html#}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
  Relatório de Gratidão
{% endblock %}

{% block extra_css %}
  <!-- O relatorio.css contém os estilos de cores e tabelas para todos os relatórios -->
  <link rel="stylesheet" href="{% static 'css/relatorio.css' %}">
{% endblock %}

{% block content_logado %}
  <div class="container my-5">
    <div class="row mb-4 report-header gratidao-header">
      <div class="col-12 col-md-8">
        <h1 class="report-title text-warning-emphasis">Relatório de Gratidão</h1>
        <p class="lead text-muted">Lista detalhada dos seus registros de gratidão.</p>
      </div>
      <div class="col-12 col-md-4 text-md-end d-flex align-items-center justify-content-md-end">
        <!-- Exibe o período atual (Mensal/Semanal/Quinzenal) -->
        <h3 class="mb-0 text-orange">{{ periodo_str }}</h3>
      </div>
    </div>

    <!-- Seletor de Período e Mês/Ano (Bootstrap Card) -->
    <div class="card shadow-sm mb-5 month-selector-card">
      <div class="card-body p-3">
        <form method="get" class="row g-3 align-items-end" action="{% url 'relatorio_gratidao' %}" id="report-filter-form">
          
          <!-- Seletor de Período -->
          <div class="col-12 col-sm-4 col-md-3">
            <label for="id_periodo" class="form-label">Período:</label>
            <select name="periodo" id="id_periodo" class="form-select">
              <option value="mensal" {% if periodo_selecionado == 'mensal' %}selected{% endif %}>Mensal</option>
              <option value="quinzenal" {% if periodo_selecionado == 'quinzenal' %}selected{% endif %}>Quinzenal</option>
              <option value="semanal" {% if periodo_selecionado == 'semanal' %}selected{% endif %}>Semanal</option>
            </select>
          </div>
          
          <!-- Seletor de Mês (Visível apenas se Mensal estiver selecionado) -->
          <div class="col-12 col-sm-4 col-md-3 {% if periodo_selecionado != 'mensal' %}d-none{% endif %}" id="mes_selector_container">
            <label for="id_mes" class="form-label">Mês:</label>
            <select name="mes" id="id_mes" class="form-select">
              {% for num, nome in meses %}
                <option value="{{ num }}" {% if num == mes_selecionado %}selected{% endif %}>
                  {{ nome }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Seletor de Ano (Visível apenas se Mensal estiver selecionado) -->
          <div class="col-12 col-sm-4 col-md-3 {% if periodo_selecionado != 'mensal' %}d-none{% endif %}" id="ano_selector_container">
            <label for="id_ano" class="form-label">Ano:</label>
            <input type="number" name="ano" id="id_ano" class="form-control" value="{{ ano_selecionado }}" min="2020" max="9999">
          </div>
          
          <!-- Botão de Ação -->
          <div class="col-12 col-md-3">
            <button type="submit" class="btn btn-warning w-100 text-white">Gerar Relatório</button>
          </div>
        </form>
      </div>
    </div>

    {% if not gratidoes %}
      <div class="alert alert-info text-center" role="alert">
        Nenhum registro de gratidão encontrado para o período selecionado.
      </div>
    {% else %}
      <div class="alert alert-success mt-4 mb-4" role="alert">
        Total de Gratidões Registradas: <strong>{{ total_gratidoes }}</strong>
      </div>
      
      <!-- Tabela do Relatório (Lista de Gratidões) - Responsiva -->
      <div class="table-responsive">
        <table class="table table-hover table-bordered table-relatorio table-gratidao align-middle shadow-sm">
          <thead>
            <tr class="text-uppercase">
              <th scope="col" class="gratidao-col-data">Data</th>
              <th scope="col" style="min-width: 400px;">Descrição (descricaoGratidao)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas do Relatório por Gratidão -->
            {% for gratidao in gratidoes %}
            <tr>
              <!-- Coluna Data -->
              <td class="gratidao-col-data">
                {{ gratidao.data|date:"d/m/Y" }}
              </td>
              <!-- Coluna Descrição -->
              <td class="text-start text-wrap-content">
                {{ gratidao.descricaogratidao|default:"-- Sem descrição --" }}
              </td>
            </tr>
            {% endfor %}
            
          </tbody>
        </table>
      </div>
    {% endif %}

    <!-- Botões de Ação e Exportação -->
    <div class="d-flex justify-content-between mt-5">
      <!-- Botão Voltar -->
      <button onclick="window.history.back()" class="btn btn-outline-secondary btn-lg shadow-sm">
        <i class="bi bi-arrow-left me-2"></i> Voltar à Página Anterior
      </button>

      <!-- Botão de Exportação (Dropdown) -->
      <div class="btn-group shadow-sm" role="group">
        <button id="btnGroupDrop1" type="button" class="btn btn-primary dropdown-toggle text-white btn-lg" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download me-2"></i> Exportar
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDrop1">
          <!-- URLs de exportação. data-base-url é usado pelo JS. -->
          <li>
            <a class="dropdown-item" href="#" id="export-csv-gratidao" data-base-url="{% url 'exportar_gratidao_csv' %}">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i> CSV (Planilha)
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" id="export-pdf-gratidao" data-base-url="{% url 'exportar_gratidao_pdf' %}">
                <i class="bi bi-file-pdf me-2"></i> PDF (Documento)
            </a>
          </li>
        </ul>
      </div>

      <!-- Botão Alterar Registros (Direciona para a URL de cadastro/gestão de gratidão) -->
      <a href="{% url 'gratidao' %}" class="btn btn-info text-white btn-lg shadow-sm">
        <i class="bi bi-pencil me-2"></i> Alterar Registros
      </a>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Script para controlar a visibilidade dos seletores de Mês/Ano e atualizar links de exportação -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const periodoSelect = document.getElementById('id_periodo');
      const mesContainer = document.getElementById('mes_selector_container');
      const anoContainer = document.getElementById('ano_selector_container');
      
      // Elementos de exportação
      const exportCsvButton = document.getElementById('export-csv-gratidao');
      const exportPdfButton = document.getElementById('export-pdf-gratidao'); 
      
      // URLs Base
      const baseUrlExportCsv = exportCsvButton ? exportCsvButton.getAttribute('data-base-url') : '';
      const baseUrlExportPdf = exportPdfButton ? exportPdfButton.getAttribute('data-base-url') : ''; 

      // Função para mostrar/esconder seletores de Mês/Ano
      function toggleDateSelectors() {
        const isMensal = periodoSelect.value === 'mensal';
        
        if (isMensal) {
          mesContainer.classList.remove('d-none');
          anoContainer.classList.remove('d-none');
        } else {
          mesContainer.classList.add('d-none');
          anoContainer.classList.add('d-none');
        }
      }
      
      // Função para atualizar os links de exportação com os parâmetros de filtro
      function updateExportLinks() {
          const periodo = periodoSelect.value;
          // Pega o valor dos campos, mesmo que estejam ocultos. Django lida com a lógica de filtro.
          const mes = document.getElementById('id_mes').value;
          const ano = document.getElementById('id_ano').value;
          
          // Reúne todos os parâmetros em um objeto URLSearchParams
          const params = new URLSearchParams();
          params.append('periodo', periodo);
          
          // Adiciona mês/ano apenas se o período for 'mensal' (embora a view possa usar para referência)
          params.append('mes', mes);
          params.append('ano', ano);

          const queryString = params.toString();

          // Atualiza o link CSV
          if (exportCsvButton && baseUrlExportCsv) {
              exportCsvButton.href = baseUrlExportCsv + '?' + queryString;
          }
          
          // Atualiza o link PDF
          if (exportPdfButton && baseUrlExportPdf) {
              exportPdfButton.href = baseUrlExportPdf + '?' + queryString;
          }
      }

      periodoSelect.addEventListener('change', toggleDateSelectors);
      periodoSelect.addEventListener('change', updateExportLinks);
      document.getElementById('id_mes').addEventListener('change', updateExportLinks);
      document.getElementById('id_ano').addEventListener('input', updateExportLinks);
      
      // Inicialização
      toggleDateSelectors(); 
      updateExportLinks(); 
    });
  </script>
{% endblock extra_js %}