{# registrarGratidao.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}

{% block title %}
    Registrar 3 Gratidões
{% endblock %}

{% block content_logado %}
    <div class="container-fluid p-4 p-md-5 gratidao-page-container">
        <form method="POST" id="form-registrar-gratidao">
            {% csrf_token %}
            
            <div class="row justify-content-center">
                <div class="col-12 col-lg-8">
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <h1 class="h1 fw-semibold gratidao-title-color mb-0">3 Gratidões do Dia</h1>
                        
                        <div class="d-flex align-items-center gap-2 gratidao-date-container bg-light rounded p-2 shadow-sm">
                            <label for="{{ formset.forms.0.data.id_for_label }}" class="text-secondary fw-medium gratidao-date-label mb-0">Data:</label>
                            
                            {# Renderiza o campo de data VISÍVEL usando o primeiro formulário #}
                            {{ formset.forms.0.data }} 
                            
                            {# Renderiza os campos de data OCULTOS dos formulários restantes (1 e 2) #}
                            {% for form in formset %}
                                {% if forloop.counter > 1 %}
                                    {{ form.data.as_hidden }} {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    {# Área de Mensagens #}
                    {% if messages %}
                        <div class="my-3">
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {# Erros não específicos do formulário #}
                    {% if formset.non_form_errors %}
                        <div class="alert alert-danger" role="alert">
                            {{ formset.non_form_errors.0 }}
                        </div>
                    {% endif %}

                    {% if form.data.errors %}
                        <div class="text-danger small mt-2">Erro na Data: {{ form.data.errors.0 }}</div>
                    {% endif %}

                    <div class="text-center mb-5">
                        <h3 class="fw-bold gratidao-question-color">O QUE VOCÊ GOSTARIA DE AGRADECER HOJE?</h3>
                    </div>
                    
                    {# CAMPOS DE GERENCIAMENTO DO FORMSET (TOTAL_FORMS, INITIAL_FORMS, etc.) #}
                    {{ formset.management_form }}
                    
                    {# Container dos 3 Campos de Gratidão #}
                    <div class="d-grid gap-4 mb-5">
                        {% for form in formset %}
                            <div class="form-group border rounded-3 p-3 shadow-sm" style="border-color: var(--lyfesync-green) !important; background-color: #f7fffb;">
                                <h5 class="fw-bold text-success mb-2">Gratidão #{{ forloop.counter }}</h5>
                                
                                {# Campo de Conteúdo #}
                                {{ form.conteudo }}
                                
                                {% if form.conteudo.errors %}
                                    <div class="text-danger small mt-2">{{ form.conteudo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    {# Botão Salvar #}
                    <div class="text-center">
                        <button type="submit" class="btn-salvar-gratidao btn btn-lg text-white fw-bold shadow-lg text-uppercase">SALVAR</button>
                    </div>
                </div>
            </div>
            
            {# Se houver gratidões cadastradas na semana, mostre-as #}
            {% if gratidoes_da_semana %}
                <hr class="my-5">
                <h4 class="fw-semibold text-secondary border-bottom pb-2 mb-4">Registros da Semana</h4>
                <div class="row g-3">
                    {% for gratidao_item in gratidoes_da_semana %}
                        <div class="col-12">
                            <div class="card p-3 rounded-3 shadow-sm border-start border-4 border-success h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <p class="small fw-semibold text-muted mb-0">{{ gratidao_item.data|date:'d/m/Y' }}</p>
                                    <a href="{% url 'alterar_gratidao' gratidao_item.pk %}" class="text-warning small fw-medium text-decoration-none">Alterar</a>
                                    {# ADICIONADO: Botão Deletar com POST #}
                                    <form action="{% url 'delete_gratidao' gratidao_item.pk %}" method="POST" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger ms-2" onclick="return confirm('Tem certeza que deseja excluir esta gratidão?');">Excluir</button>
                                    </form>
                                </div>
                                <p class="text-dark fst-italic mb-0">"{{ gratidao_item.descricaogratidao }}"</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        </form>
    </div>

    <div class="d-flex justify-content-between mt-5">
        <button onclick="window.history.back()" class="btn btn-outline-secondary btn-lg shadow-sm">
            <i class="bi bi-arrow-left me-2"></i> Voltar à Página Anterior
        </button>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form-registrar-gratidao');
        const submitButton = form ? form.querySelector('.btn-salvar-gratidao') : null;
        const dateInput = document.getElementById('id_form-0-data'); // ID padrão do campo de data visível
        
        // Lista de todos os campos de data ocultos, exceto o primeiro
        const hiddenDateInputs = document.querySelectorAll('input[id^="id_form-"][id$="-data"][type="hidden"]');
        
        // 1. Impedir Dupla Submissão E Sincronizar Data
        if (form && submitButton && dateInput) {
            form.addEventListener('submit', function() {
                // Sincroniza a data do campo VISÍVEL para todos os campos OCULTOS
                const selectedDate = dateInput.value;
                
                hiddenDateInputs.forEach(hiddenInput => {
                    hiddenInput.value = selectedDate;
                });
                
                // Desabilita o botão (anti-dupla submissão)
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Salvando...';
            });
            
            // Opcional: Copiar a data assim que ela for alterada
            dateInput.addEventListener('change', function() {
                const selectedDate = dateInput.value;
                hiddenDateInputs.forEach(hiddenInput => {
                    hiddenInput.value = selectedDate;
                });
            });
        }
        
        // 2. Foco Automático
        if (firstTextarea) {
            firstTextarea.focus();
        }
    });
</script>
{% endblock %}