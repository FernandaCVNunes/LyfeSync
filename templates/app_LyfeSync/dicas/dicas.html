{# dicas.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
Gest√£o de Dicas de Autocuidado
{% endblock %}

{% block content_logado %}

{# Necess√°rio para os estilos de sele√ß√£o de humor. Assumindo que este CSS cont√©m estilos Bootstrap-friendly. #}
<link rel="stylesheet" href="{% static 'css/homeLyfesync.css' %}">

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h1 class="h3 fw-bolder text-dark m-0">Gest√£o de Dicas de Autocuidado</h1>
                
                {# BOT√ÉO QUE AGORA ABRE O MODAL #}
                <button type="button" class="btn btn-sm btn-success fw-bold d-flex align-items-center shadow-sm"
                        data-bs-toggle="modal" data-bs-target="#adicionarDicaModal">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Adicionar Dicas
                </button>
            </div>
            
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags|default_if_none:'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="card p-4 rounded-4 shadow-lg border-0 mt-4">
                <h2 class="h5 fw-bold text-secondary mb-3">Dicas Cadastradas ({% if dicas_list %}{{ dicas_list|length }}{% else %}0{% endif %} itens)</h2>
                
                {% if dicas_list %}
                <ul class="list-group list-group-flush">
                    {% for dica in dicas_list %}
                    <li class="list-group-item d-flex justify-content-between align-items-center p-3 border-bottom">
                        <div>
                            <p class="fw-bold mb-1 text-primary">{{ dica.nomeDica }}</p>
                            <p class="mb-1 small text-muted">Humor: {{ dica.humor_relacionado }}</p> 
                            <p class="mb-0 small">{{ dica.descricaoDica|truncatechars:100 }}</p>
                        </div>
                        <div class="btn-group" role="group">
                            {# ‚úèÔ∏è Bot√£o de Edi√ß√£o (Abre o Modal de Edi√ß√£o e passa os dados) #}
                            <button type="button" class="btn btn-sm btn-outline-info" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editarDicaModal"
                                data-dica-id="{{ dica.pk }}"
                                data-dica-nome="{{ dica.nomeDica }}"
                                data-dica-descricao="{{ dica.descricaoDica }}"
                                data-dica-humor-id="{{ dica.humor_relacionado.pk }}"
                                title="Editar Dica">
                                <i class="bi bi-pencil"></i>
                            </button>
                            {# üóëÔ∏è Bot√£o de Exclus√£o (Dispara o Modal de Confirma√ß√£o) #}
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#excluirDicaModal"
                                data-dica-id="{{ dica.pk }}"
                                data-dica-nome="{{ dica.nomeDica }}"
                                title="Excluir Dica">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-info text-center mt-3" role="alert">
                    Nenhuma dica de autocuidado cadastrada ainda. Use o bot√£o "Adicionar Dicas" acima para registar a primeira!
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="adicionarDicaModal" tabindex="-1" aria-labelledby="adicionarDicaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg">
            
            {% if not form %}
                <div class="alert alert-danger p-5 text-center">
                    Erro: O formul√°rio de cadastro n√£o foi carregado corretamente. Verifique sua fun√ß√£o de *view* (registrar_dica).
                </div>
            {% else %}
                <form method="post" action="{% url 'registrar_dica' %}">
                    {% csrf_token %}
                    <div class="modal-header border-bottom-0">
                        <h5 class="modal-title fw-bolder text-dark" id="adicionarDicaModalLabel">Adicionar Nova Dica</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">

                        {# Bloco de Sele√ß√£o de Humor #}
                        <div class="mb-4">
                            <label class="form-label h5 fw-semibold text-secondary mb-3">Selecione o Humor:</label>
                            
                            {# Oculta o widget completo do Django, mas renderiza os r√°dios #}
                            <div id="hidden-radio-widget" class="d-none">{{ form.humor_relacionado }}</div>

                            <div class="d-flex flex-wrap justify-content-center gap-3 humor-grid">
                                {% for value, label in form.humor_relacionado.field.choices %}
                                {% if value %}
                                {% with image_path=humor_icon_class_map|get_item:label|default:'img/icon/adchumor.png' %}
                                <div class="humor-option-card" data-humor-container data-humor-value="{{ value }}" onclick="selectHumor('{{ value }}', this)">
                                    <img src="{% static image_path %}" alt="{{ label }}" class="humor-image-lg" />
                                    <span class="humor-label">{{ label }}</span>
                                </div>
                                {% endwith %}
                                {% endif %}
                                {% endfor %}
                            </div>

                            {% if form.humor_relacionado.errors %}
                            <div class="text-danger small mt-1">{{ form.humor_relacionado.errors }}</div>
                            {% endif %}
                        </div>
                        {# FIM DO BLOCO DE SELE√á√ÉO DE HUMOR #}
                        
                        {# Campo Nome da Dica #}
                        <div class="mb-4">
                            <label for="{{ form.nomeDica.id_for_label }}" class="form-label fw-semibold">Nome da Dica:</label>
                            {{ form.nomeDica }}
                            {% if form.nomeDica.errors %}
                            <small class="text-danger d-block mt-1">{{ form.nomeDica.errors }}</small>
                            {% endif %}
                        </div>

                        {# Campo Descri√ß√£o #}
                        <div class="mb-4">
                            <label for="{{ form.descricaoDica.id_for_label }}" class="form-label fw-semibold">Descri√ß√£o:</label>
                            {{ form.descricaoDica }}
                            {% if form.descricaoDica.errors %}
                            <small class="text-danger d-block mt-1">{{ form.descricaoDica.errors }}</small>
                            {% endif %}
                        </div>

                    </div>
                    <div class="modal-footer border-top-0 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-success fw-bold">Salvar Dica</button>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>
</div>

---

<div class="modal fade" id="editarDicaModal" tabindex="-1" aria-labelledby="editarDicaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg">
            
            {# O action ser√° preenchido via JavaScript na abertura do modal #}
            <form method="post" id="form-editar-dica">
                {% csrf_token %}
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bolder text-dark" id="editarDicaModalLabel">Editar Dica: <span id="dica-nome-edicao" class="text-info"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">

                    {# Bloco de Sele√ß√£o de Humor #}
                    <div class="mb-4">
                        <label class="form-label h5 fw-semibold text-secondary mb-3">Selecione o Humor:</label>
                        
                        {# Oculta o widget completo do Django. O JS usa os data-attributes para marcar o correto. #}
                        {# IMPORTANTE: Os inputs de r√°dio do FORM original s√£o usados (nome='humor_relacionado') #}
                        <div id="hidden-radio-widget-edit" class="d-none">
                            {% for radio in form.humor_relacionado %}
                                {{ radio }}
                            {% endfor %}
                        </div>

                        <div class="d-flex flex-wrap justify-content-center gap-3 humor-grid" id="humor-grid-edit">
                            {% for value, label in form.humor_relacionado.field.choices %}
                            {% if value %}
                            {% with image_path=humor_icon_class_map|get_item:label|default:'img/icon/adchumor.png' %}
                            <div class="humor-option-card" data-humor-container data-humor-value="{{ value }}" onclick="selectHumorEdit('{{ value }}', this)">
                                <img src="{% static image_path %}" alt="{{ label }}" class="humor-image-lg" />
                                <span class="humor-label">{{ label }}</span>
                            </div>
                            {% endwith %}
                            {% endif %}
                            {% endfor %}
                        </div>
                        
                        {% if form.humor_relacionado.errors %}
                        <div class="text-danger small mt-1">{{ form.humor_relacionado.errors }}</div>
                        {% endif %}
                    </div>
                    {# FIM DO BLOCO DE SELE√á√ÉO DE HUMOR #}
                    
                    {# Campo Nome da Dica - ID customizado para preenchimento JS #}
                    <div class="mb-4">
                        <label for="id_nomeDica_edit" class="form-label fw-semibold">Nome da Dica:</label>
                        <input type="text" name="nomeDica" id="id_nomeDica_edit" class="form-control" required placeholder="Digite um t√≠tulo curto para a dica">
                    </div>

                    {# Campo Descri√ß√£o - ID customizado para preenchimento JS #}
                    <div class="mb-4">
                        <label for="id_descricaoDica_edit" class="form-label fw-semibold">Descri√ß√£o:</label>
                        <textarea name="descricaoDica" id="id_descricaoDica_edit" rows="5" class="form-control" required placeholder="Escreva aqui a descri√ß√£o detalhada da dica..." style="min-height: 200px;"></textarea>
                    </div>

                </div>
                <div class="modal-footer border-top-0 justify-content-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-info fw-bold text-white">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

---

<div class="modal fade" id="excluirDicaModal" tabindex="-1" aria-labelledby="excluirDicaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title" id="excluirDicaModalLabel">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="form-excluir-dica">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="mb-3">Tem certeza de que deseja **excluir** a dica:</p>
                    <p class="fw-bold text-danger text-center h5" id="dica-nome-confirmacao"></p>
                    <p class="mt-3">Esta a√ß√£o n√£o pode ser desfeita.</p>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger fw-bold">Sim, Excluir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Fun√ß√£o de sele√ß√£o de humor para o modal de ADI√á√ÉO
    function selectHumor(humorValue, element) {
        const val = String(humorValue);
        const formFieldName = 'humor_relacionado';

        // 1. Remove a classe de sele√ß√£o de todos os containers DENTRO DO MODAL
        document.querySelectorAll('#adicionarDicaModal [data-humor-container]').forEach(function (el) {
            el.classList.remove('active');
        });

        // 2. Adiciona a classe de sele√ß√£o ao elemento clicado
        element.classList.add('active');

        // 3. Marca o input de r√°dio correspondente no modal de ADI√á√ÉO
        const radioInputs = document.querySelectorAll(`#adicionarDicaModal input[name="${formFieldName}"][type="radio"]`);
        let found = false;
        radioInputs.forEach(function (input) {
            if (input.value === val) {
                input.checked = true;
                found = true;
            } else {
                input.checked = false;
            }
        });
        if (!found) {
            console.warn(`Aviso: O input de r√°dio para o valor "${humorValue}" n√£o foi encontrado. O form pode falhar.`);
        }
    }

    // NOVA FUN√á√ÉO: Sele√ß√£o de humor para o modal de EDI√á√ÉO
    function selectHumorEdit(humorValue, element) {
        const val = String(humorValue);
        const formFieldName = 'humor_relacionado';

        // 1. Remove a classe de sele√ß√£o de todos os containers DENTRO DO MODAL DE EDI√á√ÉO
        document.querySelectorAll('#editarDicaModal [data-humor-container]').forEach(function (el) {
            el.classList.remove('active');
        });
        
        // 2. Adiciona a classe de sele√ß√£o (se for chamada pelo click ou pelo preenchimento inicial)
        const targetElement = element || document.querySelector(`#editarDicaModal [data-humor-value="${val}"]`);
        if (targetElement) {
            targetElement.classList.add('active');
        }

        // 3. ENCONTRA O INPUT DE R√ÅDIO CORRESPONDENTE E O MARCA COMO CHECADO
        // Busca todos os r√°dios de humor (o campo "humor_relacionado" existe no DOM duas vezes - um em cada modal)
        // Precisamos garantir que o input correto seja marcado para submiss√£o.
        // Como o Django s√≥ usa o input que est√° checado, basta marcarmos o valor correto.
        const radioInputs = document.querySelectorAll(`input[name="${formFieldName}"][type="radio"]`);
        radioInputs.forEach(function (input) {
            if (input.value === val) {
                input.checked = true;
            } else {
                input.checked = false;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        
        const formFieldName = 'humor_relacionado';

        // ------------------------------------------------------------------
        // L√≥gica de Pr√©-Sele√ß√£o e Marca√ß√£o Inicial (Para o caso de re-renderiza√ß√£o com erro no modal de ADI√á√ÉO)
        // ------------------------------------------------------------------
        const checkedRadio = document.querySelector(`#adicionarDicaModal input[name="${formFieldName}"][type="radio"]:checked`);
        let preSelectedValue = null;

        if (checkedRadio) {
            preSelectedValue = checkedRadio.value;
            
            // For√ßa a abertura do modal se houver um erro de valida√ß√£o
            if (document.querySelector('.messages .alert-danger')) {
                var modalEl = document.getElementById('adicionarDicaModal');
                if (modalEl) {
                    var modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
            }
        }

        // Inicializa o estilo do container selecionado APENAS SE HOUVER UM VALOR PR√â-SELECIONADO
        if (preSelectedValue) {
            const initialElement = document.querySelector(`#adicionarDicaModal [data-humor-value="${String(preSelectedValue)}"]`);
            if (initialElement) {
                initialElement.classList.add('active');
            }
        } else {
            // Garante que NENHUM r√°dio esteja marcado no carregamento para novos registros
            document.querySelectorAll(`#adicionarDicaModal input[name="${formFieldName}"][type="radio"]`).forEach(function (input) {
                input.checked = false;
            });
        }
        
        // ------------------------------------------------------------------
        // Inicializa Tooltips do Bootstrap
        // ------------------------------------------------------------------
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // ------------------------------------------------------------------
        // L√≥gica para o Modal de Exclus√£o
        // ------------------------------------------------------------------
        var excluirDicaModal = document.getElementById('excluirDicaModal');
        if (excluirDicaModal) {
            excluirDicaModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var dicaId = button.getAttribute('data-dica-id');
                var dicaNome = button.getAttribute('data-dica-nome');
                
                var modalNomeDica = excluirDicaModal.querySelector('#dica-nome-confirmacao');
                var modalForm = excluirDicaModal.querySelector('#form-excluir-dica');

                // Atualiza a exibi√ß√£o do nome da dica e a action do formul√°rio
                modalNomeDica.textContent = dicaNome;
                
                // Assumindo a URL de exclus√£o √© /dicas/excluir/{pk}/
                modalForm.setAttribute('action', `/dicas/excluir/${dicaId}/`);
            });
        }

        // ------------------------------------------------------------------
        // L√≥gica para o Modal de Edi√ß√£o (PREENCHIMENTO DE DADOS)
        // ------------------------------------------------------------------
        var editarDicaModal = document.getElementById('editarDicaModal');
        if (editarDicaModal) {
            editarDicaModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget; // Bot√£o que disparou o modal
                
                // 1. Obter dados dos data attributes (definidos no bot√£o de edi√ß√£o)
                var dicaId = button.getAttribute('data-dica-id');
                var dicaNome = button.getAttribute('data-dica-nome');
                var dicaDescricao = button.getAttribute('data-dica-descricao');
                var dicaHumorId = button.getAttribute('data-dica-humor-id');
                
                // 2. Referenciar elementos do modal de edi√ß√£o
                var modalTituloNome = editarDicaModal.querySelector('#dica-nome-edicao');
                var modalForm = editarDicaModal.querySelector('#form-editar-dica');
                var inputNome = editarDicaModal.querySelector('#id_nomeDica_edit');
                var inputDescricao = editarDicaModal.querySelector('#id_descricaoDica_edit');
                
                // 3. Preencher formul√°rio e t√≠tulo
                modalTituloNome.textContent = dicaNome;
                inputNome.value = dicaNome;
                inputDescricao.value = dicaDescricao;

                // 4. Atualizar a action do formul√°rio para a URL de edi√ß√£o
                // O template tag de URL precisa ser avaliado ANTES pelo Django
                var urlBase = "{% url 'alterar_dica' dica_id=0 %}".replace('/0/', '/'); // Remove o '0' do placeholder
                modalForm.setAttribute('action', urlBase + dicaId + '/');

                // 5. Pr√©-selecionar o humor
                selectHumorEdit(dicaHumorId, null);
            });
        }
    });
</script>
{% endblock content_logado%}