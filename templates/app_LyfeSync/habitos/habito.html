{# habito.html #}
{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}Meus Hábitos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                        <h6 class="text-white text-capitalize ps-3">Minha Tabela de Hábitos</h6>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">

                    {# BOTÕES DE AÇÃO #}
                    <div class="d-flex justify-content-end p-3">
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#registrarHabitoModal">Novo Hábito</button>
                        <button type="button" class="btn btn-warning me-2" onclick="abrirModalAlterar()">Alterar Selecionado</button>
                        <button type="button" class="btn btn-danger" onclick="excluirHabitosSelecionados()">Excluir Selecionado</button>
                    </div>

                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Hábito</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Frequência</th>

                                    {# Cabeçalho dos 7 dias #}
                                    {% for date, day_name in last_7_days_dict.items %}
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                        {{ day_name }}
                                        {% if date|date:"Y-m-d" == today_date|date:"Y-m-d" %}<span class="badge bg-primary">Hoje</span>{% endif %}
                                    </th>
                                    {% endfor %}
                                    <th class="text-secondary opacity-7"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for habit in habitos %}
                                <tr class="habit-row" onclick="selectHabitRow(event, {{ habit.id }})" data-habit-id="{{ habit.id }}">
                                    <td>
                                        <div class="d-flex px-2 py-1">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 text-sm">{{ habit.nome }}</h6>
                                                <p class="text-xs text-secondary mb-0">{{ habit.descricao|default:"Sem descrição." }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">{{ habit.frequencia }}</p>
                                    </td>

                                    {# Células de Status Diário #}
                                    {% for date, day_name in last_7_days_dict.items %}
                                    {# data-date é crucial para a função toggleHabitDay no JavaScript #}
                                    <td class="align-middle text-center text-sm" data-date="{{ date|date:'Y-m-d' }}" onclick="toggleHabitDay({{ habit.id }}, '{{ date|date:"Y-m-d" }}', event)">

                                        {% with status_key=date|date:"Y-m-d" %}
                                            {# Acesso ao status de conclusão usando o filtro customizado get_item #}
                                            {% if habit.completion_status|get_item:status_key %}
                                                <div class="check-box checked"></div>
                                            {% else %}
                                                <div class="check-box"></div>
                                            {% endif %}
                                        {% endwith %}

                                    </td>
                                    {% endfor %}

                                    <td class="align-middle">
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center text-secondary text-sm">Nenhum hábito registrado. Clique em 'Novo Hábito' para começar.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'app_LyfeSync/habitos/registrarHabitoModal.html' %}
{% include 'app_LyfeSync/habitos/alterarHabitoModal.html' %}


{# MODAL CUSTOMIZADO PARA CONFIRMAÇÃO DE EXCLUSÃO (Substitui window.confirm) #}
<div class="modal fade" id="confirmacaoExclusaoModal" tabindex="-1" aria-labelledby="confirmacaoExclusaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmacaoExclusaoModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza de que deseja excluir permanentemente o hábito selecionado? Esta ação não pode ser desfeita.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">Excluir Hábito</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_css %}
<style>
    /* Estilos básicos para o checkbox e a linha selecionada */
    .check-box {
        width: 18px;
        height: 18px;
        margin: auto;
        border: 2px solid #adb5bd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.15s, border-color 0.15s;
    }
    .check-box.checked {
        background-color: #4CAF50; /* Verde */
        border-color: #4CAF50;
    }
    .check-box.checked::after {
        content: '✓';
        color: white;
        font-size: 14px;
        line-height: 14px;
        text-align: center;
        display: block;
    }
    .habit-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .habit-row.selected {
        background-color: #e9ecef;
        border-left: 5px solid #007bff;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
    // Variável global para armazenar o ID do hábito selecionado
    let selectedHabitId = null;

    /**
     * Alterna a seleção da linha do hábito.
     * @param {Event} event - O evento de clique.
     * @param {number} habitId - O ID do hábito.
     */
    function selectHabitRow(event, habitId) {
        // Impede que o clique na célula do status de conclusão acione esta função
        if (event.target.closest('td[data-date]')) {
            return;
        }

        const row = event.currentTarget;
        const allRows = document.querySelectorAll('.habit-row');

        if (row.classList.contains('selected')) {
            // Desseleciona a linha se já estiver selecionada
            row.classList.remove('selected');
            selectedHabitId = null;
        } else {
            // Desseleciona todas as outras linhas
            allRows.forEach(r => r.classList.remove('selected'));
            // Seleciona a linha clicada
            row.classList.add('selected');
            selectedHabitId = habitId;
        }

        // Você pode adicionar lógica aqui para habilitar/desabilitar botões
        const btnAlterar = document.querySelector('.btn-warning');
        const btnExcluir = document.querySelector('.btn-danger');

        if (selectedHabitId !== null) {
            if (btnAlterar) btnAlterar.disabled = false;
            if (btnExcluir) btnExcluir.disabled = false;
        } else {
            if (btnAlterar) btnAlterar.disabled = true;
            if (btnExcluir) btnExcluir.disabled = true;
        }
    }

    /**
     * Alterna o status de conclusão de um dia para um hábito específico.
     * @param {number} habitId - O ID do hábito.
     * @param {string} dateString - A data no formato 'YYYY-MM-DD'.
     * @param {Event} event - O evento de clique (para impedir que a linha seja selecionada).
     */
    function toggleHabitDay(habitId, dateString, event) {
        // Impede que a seleção da linha seja ativada
        event.stopPropagation();
        
        const cell = event.currentTarget;
        const checkBox = cell.querySelector('.check-box');
        
        // Determina se será um registro (true) ou exclusão (false)
        const isChecked = !checkBox.classList.contains('checked');
        
        // Requisição AJAX para o endpoint de alternância
        fetch(`/habitos/toggle_day/${habitId}/${dateString}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_checked: isChecked })
        })
        .then(response => {
            if (!response.ok) {
                // Se a resposta não for OK, lança um erro para o bloco catch
                throw new Error('Erro ao alternar o status do hábito. Status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Atualiza a UI se a requisição for bem-sucedida
                if (isChecked) {
                    checkBox.classList.add('checked');
                } else {
                    checkBox.classList.remove('checked');
                }
                // Exibe feedback
                showToast(data.message, 'success');
            } else {
                // Exibe mensagem de erro do backend
                showToast(data.message || 'Falha na operação.', 'error');
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            showToast('Ocorreu um erro de rede ou servidor. Tente novamente.', 'error');
        });
    }


    /**
     * Função auxiliar para obter o token CSRF.
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /**
     * Abre o modal de alteração preenchendo os dados do hábito selecionado.
     */
    function abrirModalAlterar() {
        if (selectedHabitId === null) {
            showToast('Selecione um hábito para alterar.', 'warning');
            return;
        }

        fetch(`/habitos/get_data/${selectedHabitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                document.getElementById('alterar_habito_id').value = data.id;
                document.getElementById('alterar_nome').value = data.nome;
                document.getElementById('alterar_descricao').value = data.descricao;
                document.getElementById('alterar_frequencia').value = data.frequencia;

                // Abre o modal
                const alterarModal = new bootstrap.Modal(document.getElementById('alterarHabitoModal'));
                alterarModal.show();
            } else {
                showToast('Não foi possível carregar os dados do hábito.', 'error');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados para alteração:', error);
            showToast('Erro ao carregar dados para alteração.', 'error');
        });
    }

    /**
     * Exclui o hábito selecionado. Usa modal customizado em vez de window.confirm.
     */
    function excluirHabitosSelecionados() {
        if (selectedHabitId === null) {
            showToast('Selecione um hábito para excluir.', 'warning');
            return;
        }

        // Abre o modal de confirmação customizado
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmacaoExclusaoModal'));
        confirmModal.show();
        
        // Remove event listeners anteriores (se houver) e configura o clique para a exclusão
        const confirmarBtn = document.getElementById('confirmarExclusaoBtn');
        confirmarBtn.onclick = null; // Remove listeners anteriores
        
        confirmarBtn.onclick = function() {
            confirmModal.hide(); // Fecha o modal após a confirmação
            
            fetch(`/habitos/excluir/${selectedHabitId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Hábito excluído com sucesso!', 'success');
                    // Remove a linha da tabela (melhor UX)
                    const rowToRemove = document.querySelector(`.habit-row[data-habit-id="${selectedHabitId}"]`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    selectedHabitId = null; // Limpa a seleção
                    
                    // Re-desabilita os botões de ação
                    const btnAlterar = document.querySelector('.btn-warning');
                    const btnExcluir = document.querySelector('.btn-danger');
                    if (btnAlterar) btnAlterar.disabled = true;
                    if (btnExcluir) btnExcluir.disabled = true;
                    
                } else {
                    showToast(data.message || 'Falha ao excluir o hábito.', 'error');
                }
            })
            .catch(error => {
                console.error('Erro na requisição de exclusão:', error);
                showToast('Erro ao tentar excluir o hábito.', 'error');
            });
        };
    }

    /**
     * Exibe notificações (necessita de implementação de um Toast/Snackbar na masterpage)
     */
    function showToast(message, type) {
        // Esta função é um placeholder. Você deve implementá-la em sua masterpage.
        console.log(`[Toast - ${type.toUpperCase()}]: ${message}`);
        
        // Exemplo simples de uso de um componente Toast/Alert do Bootstrap (necessário configurar no masterpage)
        const alertPlaceholder = document.getElementById('toastPlaceholder') || document.body;
        const alertHtml = `
            <div class="alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show position-fixed top-0 end-0 m-3 z-index-25" role="alert" style="min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = alertHtml;
        const alertElement = tempDiv.firstChild;
        
        alertPlaceholder.appendChild(alertElement);
        setTimeout(() => alertElement.remove(), 5000); // Remove após 5 segundos
    }

    // Inicializa a desabilitação dos botões
    document.addEventListener('DOMContentLoaded', () => {
        const btnAlterar = document.querySelector('.btn-warning');
        const btnExcluir = document.querySelector('.btn-danger');
        if (btnAlterar) btnAlterar.disabled = true;
        if (btnExcluir) btnExcluir.disabled = true;
    });

</script>
{% endblock extra_js %}