{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}
{% load widget_tweaks %}

{% block title %}Meus H√°bitos{% endblock %}

{% block extra_css %}
   <link rel="stylesheet" href="{% static 'css/responsividade.css' %}">
   <link rel="stylesheet" href="{% static 'css/habito.css' %}">
{% endblock %}

{% block content_logado %}

<div class="container-fluid">

    <div class="row">
        <div class="col-12">
            <div class="text-center">
                <h1 class="text-success fw-bold text-capitalize mb-0">Meus H√°bitos</h1>
                <hr class="flex-grow-1 border-success border-5"> 
                <span class="text-center text-dark">üåü Voc√™ Consegue! Crie o Futuro que Voc√™ Deseja.</span>
                </br>
                </br>
                <p class="text-center text-dark">
                    Cumprir um h√°bito ‚Äî seja beber √°gua, ler, meditar, ou fazer exerc√≠cio ‚Äî n√£o √© apenas sobre a meta f√≠sica. 
                    √â sobre construir confian√ßa e provar a si mesmo que voc√™ √© capaz.
                </p>
                <p class="text-center text-dark">
                    Seja gentil: Se falhar hoje, n√£o desista. Amanh√£ √© uma nova chance de recome√ßar.
                </p>
                <hr class="flex-grow-1 border-sucesso border-5"> 
      {% spaceless %}
                {# BOT√ÉO NOVO H√ÅBITO #}
                 <div class="d-flex justify-content-start p-1">
                    <button type="button" class="btn btn-lg btn-success text-white me-2" data-bs-toggle="modal" data-bs-target="#registrarHabitoModal">Novo H√°bito</button>
                 </div>    
            </div>
            <div class="table-responsive p-0 mt-3">
                <table class="table align-items-center table-hover mb-0">        
                     <thead class= "border-1">
                        <tr>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle" style="width: 20%;">H√°bito </th>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle" style="width: 30%;">Descri√ß√£o</th>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle border-end" style="width: 10%;">Frequ√™ncia</th>
                             {% for day_info in last_7_days_list %}
                             <th escope="col" class="text-center bg-success.bg-gradient table-header-sm fw-bold " 
                                 data-date="{{ day_info.date_iso }}" style="width: 2%;"> 
                                 <div class="fw-bold">{{ day_info.day_name }}</div> 
                                 <div class="small">{{ day_info.date_formatted }}</div> 
                                 {% if day_info.is_today %}
                                  <span class="badge bg-primary">Hoje</span>
                                 {% endif %}
                             </th>
                             {% endfor %}
                             {# NOVA COLUNA PARA OS BOT√ïES DE A√á√ÉO #}
                             <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold text-center border-start align-middle" style="width: 10%;">A√ß√µes</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for habit in habitos %}
                        <tr class="habit-row" data-habit-id="{{ habit.id }}">
                             
                             {# COLUNA H√ÅBITO - Adicionar classe de padding reduzido (ex: p-2) #}
                             <td class="align-middle fw-bold text-start text-dark fs-6 p-1">
                                    {{ habit.nome }}
                             </td>
                             
                             {# COLUNA DESCRI√á√ÉO - Adicionar classe de padding reduzido #}
                             <td class="align-middle text-sm text-start text-muted p-1">
                                    {{ habit.descricao|default:"Sem descri√ß√£o." }}
                             </td>
                             
                             {# COLUNA FREQU√äNCIA - Adicionar classe de padding reduzido #}
                             <td class="align-middle text-center p-1 border-end">
                                    <span class="badge bg-info text-dark">{{ habit.frequencia }}</span>
                             </td>

                             {# C√©lulas de Status Di√°rio - Adicionar classe de padding reduzido #}
                             {% for day_info in last_7_days_list %}
                             <td class="align-middle text-center small p-2" 
                                    data-date="{{ day_info.date_iso }}" 
                                    onclick="toggleHabitDay({{ habit.id }}, '{{ day_info.date_iso }}', event)"> 
                                    {% with status_key=day_info.date_iso %}
                                     <input type="checkbox" class="form-check-circle" {% if habit.completion_status|get_item:status_key %}checked{% endif %}>
                                    {% endwith %}
                             </td>
                             {% endfor %}
                             
                             {# COLUNA A√á√ïES - Adicionar classe de padding reduzido #}
                             <td class="align-middle text-center small p-2 border-start">
                                    <div class="d-flex justify-content-center mt-2" >
                                       <button type="button" class="btn btn-sm btn-warning text-white me-2" 
                                             onclick="abrirModalAlterar({{ habit.id }}, event)" 
                                             data-bs-toggle="modal" data-bs-target="#alterarHabitoModal">
                                          <i class="bi bi-pencil-square"></i>
                                       </button>
                                       <button type="button" class="btn btn-sm btn-danger text-white" 
                                             onclick="abrirModalExcluir({{ habit.id }}, event)" 
                                             data-bs-toggle="modal" data-bs-target="#confirmacaoExclusaoModal">
                                          <i class="bi bi-trash-fill"></i>
                                       </button>
                                    </div>
                             </td>
                        </tr>
                        {% empty %}
                        <tr id="empty-table-row">
                             {# Colspan ajustado para ser din√¢mico (total de colunas: 3 + 7 dias + 1 a√ß√£o = 11) #}
                             <td colspan="{{ last_7_days_list|length | add:4 }}" class="text-center text-muted small py-4">Nenhum h√°bito registrado. Clique em 'Novo H√°bito' para come√ßar.</td>
                        </tr>
                        {% endfor %} {# Fim do loop #}
                     </tbody>
                </table>
            </div>
        </div>
      {% endspaceless %} 
        <div class="d-flex justify-content-between mt-5">
            <button onclick="window.history.back()" class="btn btn-outline-secondary btn-lg shadow-sm">
                    <i class="bi bi-arrow-left me-2"></i> Voltar √† P√°gina Anterior
            </button>
        </div>
    </div>
</div>

{% include 'app_LyfeSync/habitos/registrarHabito.html' %}
{% include 'app_LyfeSync/habitos/alterarHabito.html' %} 

{# MODAL DE EXCLUS√ÉO (Agora com um atributo de dados para armazenar o ID) #}
<div class="modal fade" id="confirmacaoExclusaoModal" tabindex="-1" aria-labelledby="confirmacaoExclusaoModalLabel" aria-hidden="true" data-habit-id="">
    <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content">
               <div class="modal-header">
                     <h5 class="modal-title" id="confirmacaoExclusaoModalLabel">Confirmar Exclus√£o</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                     Tem certeza de que deseja excluir permanentemente o h√°bito selecionado? Esta a√ß√£o n√£o pode ser desfeita.
               </div>
               <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                     <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">Excluir H√°bito</button>
               </div>
         </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;" id="liveToastPlaceholder">

</div>
{% endblock content_logado %}

{% block extra_js %}
<script>
    // Vari√°vel global agora s√≥ para o ID do h√°bito em A√á√ÉO (Alterar/Excluir)
    let selectedHabitId = null;

    // REMOVIDA: A fun√ß√£o selectHabitRow n√£o √© mais necess√°ria.

    function toggleHabitDay(habitId, dateString, event) {
         // Interrompe a propaga√ß√£o do clique
         event.stopPropagation();
         
         const cell = event.currentTarget;
         // CORRIGIDO: Agora seleciona o input com a classe form-check-circle
         const checkBox = cell.querySelector('.form-check-circle');
         
         const isCheckedBeforeClick = checkBox.checked; 
         
         // ATUALIZA√á√ÉO VISUAL OTIMISTA
         checkBox.checked = !isCheckedBeforeClick; 
         
         // Requisi√ß√£o AJAX
         fetch(`/habitos/toggle_day/${habitId}/${dateString}/`, { 
             method: 'POST',
             headers: {
                  'X-CSRFToken': getCookie('csrftoken'),
             },
         })
         .then(response => {
             if (!response.ok) {
                  checkBox.checked = isCheckedBeforeClick; // Desfaz
                  throw new Error(`Erro ao alternar o status do h√°bito. Status: ${response.status}`);
             }
             return response.json();
         })
         .then(data => {
             if (data.success) {
                  checkBox.checked = data.concluido; 
                  showToast(data.message || `H√°bito atualizado para ${data.concluido ? 'Conclu√≠do' : 'N√£o Conclu√≠do'}!`, 'success');
             } else {
                  checkBox.checked = isCheckedBeforeClick; // Desfaz
                  showToast(data.message || 'Falha na opera√ß√£o.', 'error');
             }
         })
         .catch(error => {
             console.error('Erro na requisi√ß√£o AJAX (Toggle):', error);
             checkBox.checked = isCheckedBeforeClick; // Desfaz
             showToast('Ocorreu um erro de rede ou servidor. Tente novamente.', 'error');
         });
    }

    function getCookie(name) {
         // Fun√ß√£o utilit√°ria para obter o token CSRF
         let cookieValue = null;
         if (document.cookie && document.cookie !== '') {
             const cookies = document.cookie.split(';');
             for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
             }
         }
         return cookieValue;
    }

   function abrirModalAlterar(habitId, event) {
      event.stopPropagation();
      
      const btnAlterar = event.currentTarget; 
      const form = document.getElementById('formAlterarHabito');
      
      const alterarModalEl = document.getElementById('alterarHabitoModal');
      const alterarModal = bootstrap.Modal.getInstance(alterarModalEl) || new bootstrap.Modal(alterarModalEl);

      // 1. Feedback de Carregamento e Desabilita o bot√£o
      const originalHtml = btnAlterar.innerHTML;
      btnAlterar.disabled = true;
      btnAlterar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      
      // 2. Requisi√ß√£o para buscar os dados do h√°bito
      fetch(`/habitos/get-data/${habitId}/`)
      .then(response => {
         if (!response.ok) {

               throw new Error('Falha ao buscar dados do h√°bito. (Status: ' + response.status + ')');
         }
         return response.json();
      })
      .then(data => {
         // 3. Preenche e exibe se for bem-sucedido
         if (data.id) {
               form.setAttribute('action', `/habitos/alterar/${data.id}/`);
               form.querySelector('input[name="nome"]').value = data.nome || '';
               form.querySelector('textarea[name="descricao"]').value = data.descricao || '';
               form.querySelector('input[name="data_inicio"]').value = data.data_inicio || ''; 
               form.querySelector('input[name="data_fim"]').value = data.data_fim || '';
               form.querySelector('input[name="quantidade"]').value = data.quantidade || 0; 
               form.querySelector('input[name="alvo"]').value = data.alvo || '';

               const frequenciaSelect = form.querySelector('select[name="frequencia"]');
               if (frequenciaSelect) {
                  frequenciaSelect.value = data.frequencia;
               }
               
               // Reabilita o bot√£o, remove o spinner, e mostra o modal
               btnAlterar.disabled = false;
               btnAlterar.innerHTML = originalHtml;
               
               alterarModal.show(); // üëà Usa a inst√¢ncia correta
         } else {
               showToast('N√£o foi poss√≠vel carregar os dados do h√°bito (dados incompletos).', 'error');
         }
      })
      .catch(error => {
         // 4. Restaura o bot√£o em caso de erro
         console.error('Erro no AJAX (Alterar):', error);
         btnAlterar.disabled = false;
         btnAlterar.innerHTML = originalHtml;
         showToast('Erro ao tentar carregar dados para altera√ß√£o.', 'error'); 
         
      });
   }

    // NOVO: Fun√ß√£o para abrir o modal de exclus√£o, passando o ID
    function abrirModalExcluir(habitId, event) {
         event.stopPropagation(); // Evita qualquer comportamento de linha
         
         // 1. Armazena o ID no atributo de dados do modal
         const confirmModalEl = document.getElementById('confirmacaoExclusaoModal');
         confirmModalEl.setAttribute('data-habit-id', habitId);
         
         // 2. Mostra o modal de confirma√ß√£o
         const confirmModal = new bootstrap.Modal(confirmModalEl);
         confirmModal.show();
    }

    // FUN√á√ÉO ATUALIZADA: Agora obt√©m o ID do atributo de dados do modal
   function excluirHabitoConfirmado(event) {
      const confirmModalEl = document.getElementById('confirmacaoExclusaoModal');
      const habitId = confirmModalEl.getAttribute('data-habit-id');
      
      if (!habitId) {
         showToast('ID do h√°bito para exclus√£o n√£o encontrado.', 'error');
         return;
      }

      const confirmarBtn = event.currentTarget;
      const originalHtml = confirmarBtn.innerHTML;
      
      // 1. Feedback de carregamento (MANTENHA ISSO)
      confirmarBtn.disabled = true;
      confirmarBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';
      
      // 2. N√£o feche o modal ainda!
      const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);

      // Requisi√ß√£o de Exclus√£o
      fetch(`/habitos/excluir/${habitId}/`, { 
         method: 'POST',
         headers: {
               'X-CSRFToken': getCookie('csrftoken')
         }
      })
      .then(response => {
         if (!response.ok) {
               throw new Error(`Erro de rede ou servidor. Status: ${response.status}`);
         }
         return response.json();
      })
      .then(data => {
         // Restaura o bot√£o e o estado (MANTENHA ISSO)
         confirmarBtn.disabled = false;
         confirmarBtn.innerHTML = originalHtml;
         confirmModalEl.removeAttribute('data-habit-id'); 

         if (data.success) {
               // SUCESSO: AGORA FECHE O MODAL E ATUALIZE A TELA
               if (confirmModal) {
                ¬† confirmModal.hide(); 
               }
               showToast(data.message || 'H√°bito exclu√≠do com sucesso!', 'error');
               setTimeout(() => {
                ¬† window.location.reload(); 
               }, 3000);
        ¬†} else {
               if (confirmModal) {
                  confirmModal.show(); 
               }
               showToast(data.message || 'Falha ao excluir o h√°bito.', 'error');
         }
      })
      .catch(error => {
         console.error('Erro na requisi√ß√£o de exclus√£o:', error);
         
         // RESTAURA√á√ÉO COMPLETA em caso de ERRO DE REDE/SERVIDOR
         confirmarBtn.disabled = false;
         confirmarBtn.innerHTML = originalHtml;
         confirmModalEl.removeAttribute('data-habit-id'); 
         
         showToast('Erro grave ao tentar excluir o h√°bito. Tente recarregar a p√°gina.', 'error');
      });
   }

    // NOVO: Fun√ß√£o showToast 
   function showToast(message, type) {
      const toastPlaceholder = document.getElementById('liveToastPlaceholder');
         if (!toastPlaceholder) {
            console.log(`[Toast Fallback]: ${message}`);
            return;
         }

      const alertClass =
         type === 'success'
               ? 'bg-success'
               : type === 'warning'
                  ? 'bg-warning'
                  : 'bg-danger';

      const toastHtml = `
         <div class="toast align-items-center text-white ${alertClass} border-0"
               role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
               <div class="d-flex">
                  <div class="toast-body fw-bold">
                     ${message}
                  </div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto"
                     data-bs-dismiss="toast" aria-label="Close"></button>
               </div>
         </div>
      `;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = toastHtml;

      const toastElement = tempDiv.firstElementChild;
      toastPlaceholder.appendChild(toastElement);

      const bsToast = new bootstrap.Toast(toastElement);
      bsToast.show();

      toastElement.addEventListener('hidden.bs.toast', () => {
         toastElement.remove();
      });
   }

   document.addEventListener('DOMContentLoaded', () => {

      // -----------------------------------------------------------------
      // 1. Inicializa as inst√¢ncias das Modais
      // -----------------------------------------------------------------
      const alterarModalEl = document.getElementById('alterarHabitoModal');
      const exclusaoModalEl = document.getElementById('confirmacaoExclusaoModal');
      
      // Obtenha as inst√¢ncias do Bootstrap. Elas ser√£o null se o elemento n√£o existir
      const alterarModal = alterarModalEl ? bootstrap.Modal.getInstance(alterarModalEl) || new bootstrap.Modal(alterarModalEl) : null;
      const exclusaoModal = exclusaoModalEl ? bootstrap.Modal.getInstance(exclusaoModalEl) || new bootstrap.Modal(exclusaoModalEl) : null;


      // -----------------------------------------------------------------
      // 2. CORRE√á√ÉO CR√çTICA: Limpeza For√ßada do Backdrop ao Fechar a Modal
      // Aplica-se √†s duas modais para evitar o erro de backdrop persistente
      // -----------------------------------------------------------------
      function setupModalCleanup(modalElement) {
         if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function () {
               // 1. Remove a classe 'modal-open' do <body> (que desabilita a rolagem)
               document.body.classList.remove('modal-open');
               
               // 2. Procura e remove o backdrop manualmente, se ele ainda estiver no DOM
               const backdrop = document.querySelector('.modal-backdrop');
               if (backdrop) {
                  backdrop.remove();
               }
            });
         }
      }

      setupModalCleanup(alterarModalEl);
      setupModalCleanup(exclusaoModalEl);

      // -----------------------------------------------------------------
      // 3. Listener do Bot√£o de Confirma√ß√£o de Exclus√£o
      // -----------------------------------------------------------------
      const confirmarBtn = document.getElementById('confirmarExclusaoBtn');
      if (confirmarBtn) {
         // Assume-se que 'excluirHabitoConfirmado' est√° definida no escopo superior.
         confirmarBtn.addEventListener('click', excluirHabitoConfirmado); 
      }

      // -----------------------------------------------------------------
      // 4. Listener do Formul√°rio de Altera√ß√£o (AJAX Submission)
      // -----------------------------------------------------------------
      const formAlterar = document.getElementById('formAlterarHabito');
      if (formAlterar) {
         formAlterar.addEventListener('submit', function(e) {
            e.preventDefault();
            
               // Simplesmente submete via AJAX
            fetch(this.action, { 
                  method: 'POST',
                  body: new FormData(this),
                  headers: {
                     'X-CSRFToken': getCookie('csrftoken'),
                  }
            })
            .then(response => {
                  // Se n√£o for sucesso, assume erro e tenta parsear o JSON para obter detalhes
                  if (!response.ok) {
                     // Aqui voc√™ pode adicionar l√≥gica para ler errors do Django se o status for 400
                     throw new Error(`Erro ao salvar. Status: ${response.status}`);
                  }
                  return response.json(); 
            })
            .then(data => {
                  if (data.success) {
                     showToast(data.message || 'H√°bito alterado com sucesso!', 'success');
                     
                     // FECHA O MODAL USANDO A INST√ÇNCIA OBTIDA NO IN√çCIO
                     if (alterarModal) {
                        alterarModal.hide();
                     }
                     
                     // RECARREGA A P√ÅGINA
                     window.location.reload(); 
                  } else {
                     showToast(data.message || 'Falha ao alterar o h√°bito.', 'error');
                  }
            })
            .catch(error => {
               console.error('Erro no AJAX (Alterar Submiss√£o):', error);
               // Fecha a modal em caso de erro de rede ou servidor
               if (alterarModal) {
                  alterarModal.hide(); 
               }
               showToast('Erro ao submeter a altera√ß√£o. Tente novamente.', 'error');
            });
         });
      }
   });

</script>
{% endblock extra_js %}