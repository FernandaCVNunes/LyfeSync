{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}Meus HÃ¡bitos{% endblock %}

{% block extra_css %}
   <link rel="stylesheet" href="{% static 'css/responsividade.css' %}">
   <link rel="stylesheet" href="{% static 'css/habito.css' %}">
{% endblock %}

{% block content_logado %}

<div class="container-fluid">
   {# Bloco para exibir mensagens do Django #}
   {% if messages %}
      <div class="messages mb-3">
         {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
               {{ message }}
               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
         {% endfor %}
      </div>
   {% endif %}

   Â <div class="row">
        <div class="col-12">
        Â    <div class="text-center">
                <h1 class="text-success fw-bold text-capitalize mb-0">Meus HÃ¡bitos</h1>
                <hr class="flex-grow-1 border-success border-5"> 
                <span class="text-center text-dark">ğŸŒŸ VocÃª Consegue! Crie o Futuro que VocÃª Deseja.</span>
                </br>
                </br>
                <p class="text-center text-dark">
                    Cumprir um hÃ¡bito â€” seja beber Ã¡gua, ler, meditar, ou fazer exercÃ­cio â€” nÃ£o Ã© apenas sobre a meta fÃ­sica. 
                    Ã‰ sobre construir confianÃ§a e provar a si mesmo que vocÃª Ã© capaz.
                </p>
                <p class="text-center text-dark">
                    Seja gentil: Se falhar hoje, nÃ£o desista. AmanhÃ£ Ã© uma nova chance de recomeÃ§ar.
                </p>
                <hr class="flex-grow-1 border-sucesso border-5"> 
      {% spaceless %}
                {# BOTÃƒO NOVO HÃBITO #}
                Â <div class="d-flex justify-content-start p-1">
                    <button type="button" class="btn btn-lg btn-success text-white me-2" data-bs-toggle="modal" data-bs-target="#registrarHabitoModal">Novo HÃ¡bito</button>
                Â </div>    
            </div>
            <div class="table-responsive p-0 mt-3">
                <table class="table align-items-center table-hover mb-0">        
                    Â <thead class= "border-1">
                        <tr>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle" style="width: 20%;">HÃ¡bito </th>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle" style="width: 30%;">DescriÃ§Ã£o</th>
                              <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold ps-3 align-middle border-end" style="width: 10%;">FrequÃªncia</th>
                            Â {% for day_info in last_7_days_list %}
                            Â <th escope="col" class="text-center bg-success.bg-gradient table-header-sm fw-bold " 
                                 data-date="{{ day_info.date_iso }}" style="width: 2%;"> 
                                 <div class="fw-bold">{{ day_info.day_name }}</div> 
                                 <div class="small">{{ day_info.date_formatted }}</div> 
                                 {% if day_info.is_today %}
                                 Â <span class="badge bg-primary">Hoje</span>
                                 {% endif %}
                            Â </th>
                            Â {% endfor %}
                            Â {# NOVA COLUNA PARA OS BOTÃ•ES DE AÃ‡ÃƒO #}
                            Â <th escope="col" class="text-uppercase bg-success.bg-gradient table-header-sm fw-bold text-center border-start align-middle" style="width: 10%;">AÃ§Ãµes</th>
                        </tr>
                    Â </thead>
                    Â <tbody>
                        {% for habit in habitos %}
                        <tr class="habit-row" data-habit-id="{{ habit.id }}">
                            Â 
                            Â {# COLUNA HÃBITO - Adicionar classe de padding reduzido (ex: p-2) #}
                            Â <td class="align-middle fw-bold text-start text-dark fs-6 p-1">
                                    {{ habit.nome }}
                            Â </td>
                            Â 
                            Â {# COLUNA DESCRIÃ‡ÃƒO - Adicionar classe de padding reduzido #}
                            Â <td class="align-middle text-sm text-start text-muted p-1">
                                    {{ habit.descricao|default:"Sem descriÃ§Ã£o." }}
                            Â </td>
                            Â 
                            Â {# COLUNA FREQUÃŠNCIA - Adicionar classe de padding reduzido #}
                            Â <td class="align-middle text-center p-1 border-end">
                                    <span class="badge bg-info text-dark">{{ habit.frequencia }}</span>
                            Â </td>

                            Â {# CÃ©lulas de Status DiÃ¡rio - Adicionar classe de padding reduzido #}
                            Â {% for day_info in last_7_days_list %}
                            Â <td class="align-middle text-center small p-2" 
                                    data-date="{{ day_info.date_iso }}" 
                                    onclick="toggleHabitDay({{ habit.id }}, '{{ day_info.date_iso }}', event)"> 
                                    {% with status_key=day_info.date_iso %}
                                    Â <input type="checkbox" class="form-check-circle" {% if habit.completion_status|get_item:status_key %}checked{% endif %}>
                                    {% endwith %}
                            Â </td>
                            Â {% endfor %}
                            Â 
                            Â {# COLUNA AÃ‡Ã•ES - Adicionar classe de padding reduzido #}
                            Â <td class="align-middle text-center small p-2 border-start">
                                    <div class="d-flex justify-content-center mt-2" >
                                    <button type="button" class="btn btn-sm btn-warning text-white me-2" 
                                            onclick="abrirModalAlterar({{ habit.id }}, event)" 
                                            data-bs-toggle="modal" data-bs-target="#alterarHabitoModal">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger text-white" 
                                            onclick="abrirModalExcluir({{ habit.id }}, event)" 
                                            data-bs-toggle="modal" data-bs-target="#confirmacaoExclusaoModal">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    </div>
                            Â </td>
                        </tr>
                        {% empty %}
                        <tr id="empty-table-row">
                            Â {# Colspan ajustado para ser dinÃ¢mico (total de colunas: 3 + 7 dias + 1 aÃ§Ã£o = 11) #}
                            Â <td colspan="{{ last_7_days_list|length | add:4 }}" class="text-center text-muted small py-4">Nenhum hÃ¡bito registrado. Clique em 'Novo HÃ¡bito' para comeÃ§ar.</td>
                        </tr>
                        {% endfor %} {# Fim do loop #}
                    Â </tbody>
                </table>
            </div>
        </div>
      {% endspaceless %} 
        <div class="d-flex justify-content-between mt-5">
            <button onclick="window.history.back()" class="btn btn-outline-secondary btn-lg shadow-sm">
                    <i class="bi bi-arrow-left me-2"></i> Voltar Ã  PÃ¡gina Anterior
            </button>
        </div>
    </div>
</div>

{% include 'app_LyfeSync/habitos/registrarHabito.html' %}
{% include 'app_LyfeSync/habitos/alterarHabito.html' %} 

{# MODAL DE EXCLUSÃƒO (Agora com um atributo de dados para armazenar o ID) #}
<div class="modal fade" id="confirmacaoExclusaoModal" tabindex="-1" aria-labelledby="confirmacaoExclusaoModalLabel" aria-hidden="true" data-habit-id="">
   Â <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content">
               <div class="modal-header">
                     <h5 class="modal-title" id="confirmacaoExclusaoModalLabel">Confirmar ExclusÃ£o</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                     Tem certeza de que deseja excluir permanentemente o hÃ¡bito selecionado? Esta aÃ§Ã£o nÃ£o pode ser desfeita.
               </div>
               <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                     <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">Excluir HÃ¡bito</button>
               </div>
         </div>
   Â </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;" id="liveToastPlaceholder">

</div>
{% endblock content_logado %}

{% block extra_js %}
<script>
   Â // VariÃ¡vel global agora sÃ³ para o ID do hÃ¡bito em AÃ‡ÃƒO (Alterar/Excluir)
   Â let selectedHabitId = null;

   Â // REMOVIDA: A funÃ§Ã£o selectHabitRow nÃ£o Ã© mais necessÃ¡ria.

   Â function toggleHabitDay(habitId, dateString, event) {
         // Interrompe a propagaÃ§Ã£o do clique
         event.stopPropagation();
         
         const cell = event.currentTarget;
         // CORRIGIDO: Agora seleciona o input com a classe form-check-circle
         const checkBox = cell.querySelector('.form-check-circle');
         
         const isCheckedBeforeClick = checkBox.checked; 
         
         // ATUALIZAÃ‡ÃƒO VISUAL OTIMISTA
         checkBox.checked = !isCheckedBeforeClick; 
         
         // RequisiÃ§Ã£o AJAX
         fetch(`/habitos/toggle_day/${habitId}/${dateString}/`, { 
            Â method: 'POST',
            Â headers: {
                  'X-CSRFToken': getCookie('csrftoken'),
            Â },
         })
         .then(response => {
            Â if (!response.ok) {
                  checkBox.checked = isCheckedBeforeClick; // Desfaz
                  throw new Error(`Erro ao alternar o status do hÃ¡bito. Status: ${response.status}`);
            Â }
            Â return response.json();
         })
         .then(data => {
            Â if (data.success) {
                  checkBox.checked = data.concluido; 
                  showToast(data.message || `HÃ¡bito atualizado para ${data.concluido ? 'ConcluÃ­do' : 'NÃ£o ConcluÃ­do'}!`, 'success');
            Â } else {
                  checkBox.checked = isCheckedBeforeClick; // Desfaz
                  showToast(data.message || 'Falha na operaÃ§Ã£o.', 'error');
            Â }
         })
         .catch(error => {
            Â console.error('Erro na requisiÃ§Ã£o AJAX (Toggle):', error);
            Â checkBox.checked = isCheckedBeforeClick; // Desfaz
            Â showToast('Ocorreu um erro de rede ou servidor. Tente novamente.', 'error');
         });
   Â }

   Â function getCookie(name) {
         // FunÃ§Ã£o utilitÃ¡ria para obter o token CSRF
         let cookieValue = null;
         if (document.cookie && document.cookie !== '') {
            Â const cookies = document.cookie.split(';');
            Â for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                     Â cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                     Â break;
                  }
            Â }
         }
         return cookieValue;
   Â }

   Â // FUNÃ‡ÃƒO ATUALIZADA: Agora recebe o habitId diretamente do clique no botÃ£o
   Â function abrirModalAlterar(habitId, event) {
         event.stopPropagation(); // Evita qualquer comportamento de linha
         
         const btnAlterar = event.currentTarget; 
         
         // 1. Feedback de Carregamento e Desabilita o botÃ£o
         const originalHtml = btnAlterar.innerHTML;
         btnAlterar.disabled = true;
         btnAlterar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

         const alterarModal = new bootstrap.Modal(document.getElementById('alterarHabitoModal'));
         const form = document.getElementById('formAlterarHabito');
         
         // 2. RequisiÃ§Ã£o para buscar os dados do hÃ¡bito
         fetch(`/habitos/get-data/${habitId}/`)
         .then(response => {
            Â if (!response.ok) {
                  btnAlterar.disabled = false;
                  btnAlterar.innerHTML = originalHtml;
                  showToast('Falha ao buscar dados do hÃ¡bito.', 'error');
                  throw new Error('Falha ao buscar dados do hÃ¡bito. (Status: ' + response.status + ')');
            Â }
            Â return response.json();
         })
         .then(data => {
            Â // 3. Preenche e exibe se for bem-sucedido
            Â if (data.id) {
                  // Define o atributo 'action' do formulÃ¡rio com o ID
                  form.setAttribute('action', `/habitos/alterar/${data.id}/`);
                  
                  // Preenche campos
                  form.querySelector('input[name="nome"]').value = data.nome || '';
                  form.querySelector('textarea[name="descricao"]').value = data.descricao || '';
                  form.querySelector('input[name="data_inicio"]').value = data.data_inicio || ''; 
                  form.querySelector('input[name="data_fim"]').value = data.data_fim || '';
                  form.querySelector('input[name="quantidade"]').value = data.quantidade || 0;
                  form.querySelector('input[name="alvo"]').value = data.alvo || '';
                  form.querySelector('input[name="unidade"]').value = data.unidade || '';

                  const frequenciaSelect = form.querySelector('select[name="frequencia"]');
                  if (frequenciaSelect) {
                     Â frequenciaSelect.value = data.frequencia;
                  }
                  
                  // Reabilita o botÃ£o, remove o spinner, e mostra o modal
                  btnAlterar.disabled = false;
                  btnAlterar.innerHTML = originalHtml;
                  
                  alterarModal.show();
            Â } else {
                  showToast('NÃ£o foi possÃ­vel carregar os dados do hÃ¡bito (dados incompletos).', 'error');
            Â }
         })
         .catch(error => {
            Â // 4. Restaura o botÃ£o em caso de erro
            Â console.error('Erro no AJAX (Alterar):', error);
            Â btnAlterar.disabled = false;
            Â btnAlterar.innerHTML = originalHtml;
            Â showToast('Erro ao tentar carregar dados para alteraÃ§Ã£o.', 'error'); 
         });
   Â }

   Â // NOVO: FunÃ§Ã£o para abrir o modal de exclusÃ£o, passando o ID
   Â function abrirModalExcluir(habitId, event) {
         event.stopPropagation(); // Evita qualquer comportamento de linha
         
         // 1. Armazena o ID no atributo de dados do modal
         const confirmModalEl = document.getElementById('confirmacaoExclusaoModal');
         confirmModalEl.setAttribute('data-habit-id', habitId);
         
         // 2. Mostra o modal de confirmaÃ§Ã£o
         const confirmModal = new bootstrap.Modal(confirmModalEl);
         confirmModal.show();
   Â }

   Â // FUNÃ‡ÃƒO ATUALIZADA: Agora obtÃ©m o ID do atributo de dados do modal
   Â function excluirHabitoConfirmado(event) {
         const confirmModalEl = document.getElementById('confirmacaoExclusaoModal');
         const habitId = confirmModalEl.getAttribute('data-habit-id');
         
         if (!habitId) {
            Â showToast('ID do hÃ¡bito para exclusÃ£o nÃ£o encontrado.', 'error');
            Â return;
         }

         const confirmarBtn = event.currentTarget;
         const originalHtml = confirmarBtn.innerHTML;
         
         // Feedback de carregamento
         confirmarBtn.disabled = true;
         confirmarBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excluindo...';
         
         // Esconde o modal imediatamente
         const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
         if (confirmModal) confirmModal.hide();

         // RequisiÃ§Ã£o de ExclusÃ£o
         fetch(`/habitos/excluir/${habitId}/`, { 
            Â method: 'POST',
            Â headers: {
                  'X-CSRFToken': getCookie('csrftoken')
            Â }
         })
         .then(response => response.json())
         .then(data => {
            Â // Restaura o botÃ£o e o estado
            Â confirmarBtn.disabled = false;
            Â confirmarBtn.innerHTML = originalHtml;
            Â confirmModalEl.removeAttribute('data-habit-id'); // Limpa o ID

            Â if (data.success) {
                  showToast(data.message || 'HÃ¡bito excluÃ­do com sucesso!', 'success');
                  
                  // LÃ³gica de remoÃ§Ã£o da linha
                  const rowToRemove = document.querySelector(`.habit-row[data-habit-id="${habitId}"]`);
                  if (rowToRemove) {
                     Â rowToRemove.remove();
                     Â 
                     Â // Verifica se a tabela ficou vazia (BÃ”NUS)
                     Â const tbody = rowToRemove.closest('tbody');
                     Â if (tbody && tbody.querySelectorAll('.habit-row').length === 0) { 
                           const tableHeaderCount = document.querySelectorAll('thead th').length;
                           const emptyRowHtml = `<tr id="empty-table-row"><td colspan="${tableHeaderCount}" class="text-center text-muted small py-4">Nenhum hÃ¡bito registrado. Clique em 'Novo HÃ¡bito' para comeÃ§ar.</td></tr>`;
                           tbody.innerHTML = emptyRowHtml;
                     Â }
                  } 
            Â } else {
                  showToast(data.message || 'Falha ao excluir o hÃ¡bito.', 'error');
            Â }
         })
         .catch(error => {
            Â console.error('Erro na requisiÃ§Ã£o de exclusÃ£o:', error);
            Â // Restaura o botÃ£o e o estado em caso de erro
            Â confirmarBtn.disabled = false;
            Â confirmarBtn.innerHTML = originalHtml;
            Â confirmModalEl.removeAttribute('data-habit-id'); 
            Â showToast('Erro ao tentar excluir o hÃ¡bito.', 'error');
         });
   Â }

   Â // NOVO: FunÃ§Ã£o showToast (mantida como estava, muito boa!)
   Â function showToast(message, type) {
         const toastPlaceholder = document.getElementById('liveToastPlaceholder');
         if (!toastPlaceholder) {
            Â Â console.log(`[Toast Fallback]: ${message}`);
            Â Â return; 
         }

         const alertClass = type === 'success' ? 'bg-success' : type === 'warning' ? 'bg-warning' : 'bg-danger';
         
         const toastHtml = `
            Â <div class="toast align-items-center text-white ${alertClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                  <div class="d-flex">
                     Â <div class="toast-body fw-bold">
                           ${message}
                     Â </div>
                     Â <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
            Â </div>
         `;

         const tempDiv = document.createElement('div');
         tempDiv.innerHTML = toastHtml;
         const toastElement = tempDiv.firstChild;
         
         toastPlaceholder.appendChild(toastElement);

         const bsToast = new bootstrap.Toast(toastElement);
         bsToast.show();

         toastElement.addEventListener('hidden.bs.toast', () => {
            Â toastElement.remove();
         });
   Â }

   Â document.addEventListener('DOMContentLoaded', () => {
         // NOVO: Adiciona o listener para o botÃ£o de confirmaÃ§Ã£o de exclusÃ£o
         const confirmarBtn = document.getElementById('confirmarExclusaoBtn');
         if (confirmarBtn) {
            Â confirmarBtn.addEventListener('click', excluirHabitoConfirmado);
         }
   Â });

</script>
{% endblock extra_js %}