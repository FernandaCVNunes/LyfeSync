{% extends 'app_LyfeSync/layouts/masterpage_logado.html' %}
{% load static %}
{% load custom_filters %}
{% load app_LyfeSync_extras %}

{% block title %}
  {% if form.instance.pk %}
    Alterar Humor
  {% else %}
    Registrar Humor
  {% endif %}
{% endblock %}

{% block content_logado %}
  <div class="container py-4 py-md-5">
    <div class="row justify-content-center">
      {# Coluna Principal do Formulário - Ocupa toda a largura, centralizado #}
      <div class="col-12 col-lg-8 card p-4 p-md-5 rounded-4 shadow-lg border-0 bg-white">
        <h2 class="fw-bold text-success mb-4 humor-title">
          {% if form.instance.pk %}
            Edite seu humor registrado:
          {% else %}
            Como você está se sentindo hoje?
          {% endif %}
        </h2>

        {# AÇÃO DINÂMICA: Verifica se é uma edição (usa form.instance.pk) ou um novo registro #}
        <form id="form-registro-humor"
          method="POST"
          action="{% if form.instance.pk %}
            {% url 'alterarHumor' form.instance.pk %}
          {% else %}
            {% url 'registrarHumor' %}
          {% endif %}">
          {% csrf_token %}

          <div class="mb-4">
            <label for="id_data" class="form-label h5 fw-semibold text-secondary mb-2">Data:</label>
            <input type="date" id="id_data" name="data" class="form-control" value="{{ form.data.value|default_if_none:'' }}" required />

            {% if form.data.errors %}
              <div class="text-danger small mt-1">{{ form.data.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-4">
            <label class="form-label h5 fw-semibold text-secondary mb-3">Selecione seu Humor:</label>

            {# Oculta o widget completo do Django de forma robusta e garante que o item vazio (None) não é exibido #}
            <div id="hidden-radio-widget" class="d-none">{{ form.estado }}</div>

            <div class="d-flex flex-wrap justify-content-center gap-3 humor-grid">
              {% for value, label in form.estado.field.choices %}
                {# Itera apenas sobre os valores que não são a opção vazia inicial ('') #}
                {% if value %}
                  {% with image_path=humor_icon_class_map|get_item:value|default:'img/icon/adchumor.png' %}
                    {# Usando a classe CSS para o card de opção #}
                    <div class="humor-option-card" data-humor-container data-humor-value="{{ value }}" onclick="selectHumor('{{ value }}', this)">
                      {# Usando a classe CSS humor-image-lg #}
                      <img src="{% static image_path %}" alt="{{ label }}" class="humor-image-lg" />

                      {# Rótulo customizado, usando o CSS humor-label #}
                      <span class="humor-label">{{ label }}</span>
                    </div>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            </div>

            {% if form.estado.errors %}
              <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-4">
            <label for="id_descricaohumor" class="form-label h5 fw-semibold text-secondary mb-2">Descrição:</label>
            <textarea id="id_descricaohumor" name="descricaohumor" rows="8" placeholder="Descreva brevemente o que motivou seu humor hoje..." class="form-control custom-textarea">{{ form.descricaohumor.value|default_if_none:'' }}</textarea>

            {% if form.descricaohumor.errors %}
              <div class="text-danger small mt-1">{{ form.descricaohumor.errors }}</div>
            {% endif %}
          </div>

          <div class="d-flex justify-content-end mt-4">
            {# Aplica a classe customizada de botão de salvar (btn-salvar-form) #}
            <button type="submit" class="btn-salvar-form text-white fw-bold rounded-3 shadow-lg">SALVAR</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Função JavaScript para gerenciar a seleção de humor
    function selectHumor(humorValue, element) {
      // Garante que o valor de comparação é sempre uma string
      const val = String(humorValue) // 1. Remove a classe de seleção de todos os containers
      document.querySelectorAll('[data-humor-container]').forEach(function (el) {
        el.classList.remove('active') // Usando 'active' para consistência com o CSS
      }) // 2. Adiciona a classe de seleção ao elemento clicado (o container div)
      element.classList.add('active') // 3. ENCONTRA O INPUT DE RÁDIO CORRESPONDENTE E O MARCA COMO CHECADO
      const radioInputs = document.querySelectorAll('input[name="estado"][type="radio"]')
      let found = false
      radioInputs.forEach(function (input) {
        if (input.value === val) {
          // Usa a variável 'val' corrigida
          input.checked = true
          found = true
        } else {
          input.checked = false
        }
      })
      if (!found) {
        console.warn(`Aviso: O input de rádio para o valor "${humorValue}" não foi encontrado. O form pode falhar.`)
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      // Define a data atual se o campo estiver vazio (apenas para novos registros)
      const dateInput = document.getElementById('id_data')
      if (dateInput && !dateInput.value) {
        const today = new Date()
        const yyyy = today.getFullYear()
        let mm = today.getMonth() + 1
        let dd = today.getDate()
        if (mm < 10) mm = '0' + mm
        if (dd < 10) dd = '0' + dd
        dateInput.value = yyyy + '-' + mm + '-' + dd
      } // ------------------------------------------------------------------ // Lógica de Pré-Seleção e Marcação Inicial // ------------------------------------------------------------------ // Localiza o rádio que o Django marcou como 'checked' (se for uma edição ou validação falha)
      const checkedRadio = document.querySelector('input[name="estado"][type="radio"]:checked')
      let preSelectedValue = null
      if (checkedRadio) {
        // Se o Django já marcou um rádio, usamos esse valor.
        preSelectedValue = checkedRadio.value
      } // Inicializa o estilo do container selecionado APENAS SE HOUVER UM VALOR PRÉ-SELECIONADO
      if (preSelectedValue) {
        // CORREÇÃO: Usa um seletor mais específico para encontrar o elemento
        const initialElement = document.querySelector(`[data-humor-value="${String(preSelectedValue)}"]`)
        if (initialElement) {
          // O rádio já está marcado pelo Django, mas adicionamos o CSS 'active'
          initialElement.classList.add('active')
        }
      } else {
        // Garante que NENHUM rádio esteja marcado no carregamento para novos registros
        document.querySelectorAll('input[name="estado"][type="radio"]').forEach(function (input) {
          input.checked = false
        })
      }
    })
  </script>
{% endblock %}
